/*!CK:1428744203!*//*1385976492,173220921*/

if (self.CavalryLogger) { CavalryLogger.start_js(["larIW"]); }

__d("MercuryActionStatus",[],function(a,b,c,d,e,f){e.exports={UNCONFIRMED:3,UNSENT:0,RESENDING:7,RESENT:6,UNABLE_TO_CONFIRM:5,FAILED_UNKNOWN_REASON:4,SUCCESS:1,ERROR:10};});
__d("MercuryActionTypeConstants",[],function(a,b,c,d,e,f){e.exports={LOG_MESSAGE:"ma-type:log-message",CLEAR_CHAT:"ma-type:clear_chat",UPDATE_ACTION_ID:"ma-type:update-action-id",DELETE_MESSAGES:"ma-type:delete-messages",CHANGE_FOLDER:"ma-type:change-folder",SEND_MESSAGE:"ma-type:send-message",CHANGE_ARCHIVED_STATUS:"ma-type:change-archived-status",DELETE_THREAD:"ma-type:delete-thread",USER_GENERATED_MESSAGE:"ma-type:user-generated-message",CHANGE_READ_STATUS:"ma-type:change_read_status",CHANGE_MUTE_SETTINGS:"ma-type:change-mute-settings"};});
__d("MercuryAPIArgsSource",[],function(a,b,c,d,e,f){e.exports={JEWEL:"jewel",CHAT:"chat",MERCURY:"mercury",WEBMESSENGER:"web_messenger"};});
__d("MercuryAttachmentContentType",[],function(a,b,c,d,e,f){e.exports={UNKNOWN:"attach:unknown",PHOTO:"attach:image",VIDEO:"attach:video",MSWORD:"attach:ms:word",VOICE:"attach:voice",MSPPT:"attach:ms:ppt",TEXT:"attach:text",MUSIC:"attach:music",MSXLS:"attach:ms:xls"};});
__d("MercuryAttachmentType",[],function(a,b,c,d,e,f){e.exports={STICKER:"sticker",PHOTO:"photo",FILE:"file",SHARE:"share",ERROR:"error"};});
__d("MercuryErrorType",[],function(a,b,c,d,e,f){e.exports={SERVER:1,TRANSPORT:2,TIMEOUT:3};});
__d("MercuryGenericConstants",[],function(a,b,c,d,e,f){e.exports={MAX_THREAD_NAME_LENGTH:"250",PENDING_THREAD_ID:"pending:pending"};});
__d("MercuryGlobalActionType",[],function(a,b,c,d,e,f){e.exports={MARK_ALL_READ:"mga-type:mark-all-read"};});
__d("MercuryLogMessageType",[],function(a,b,c,d,e,f){e.exports={SERVER_ERROR:"log:error-msg",UNSUBSCRIBE:"log:unsubscribe",JOINABLE_JOINED:"log:joinable-joined",JOINABLE_CREATED:"log:joinable-created",LIVE_LISTEN:"log:live-listen",PHONE_CALL:"log:phone-call",THREAD_IMAGE:"log:thread-image",THREAD_NAME:"log:thread-name",VIDEO_CALL:"log:video-call",SUBSCRIBE:"log:subscribe"};});
__d("MercuryParticipantTypes",[],function(a,b,c,d,e,f){e.exports={FRIEND:"friend",USER:"user",THREAD:"thread",EVENT:"event",PAGE:"page"};});
__d("MercuryPayloadSource",[],function(a,b,c,d,e,f){e.exports={SERVER_INITIAL_DATA:"server_initial_data",CLIENT_DELETE_THREAD:"client_delete_thread",SERVER_SAVE_DRAFT:"server_save_draft",SERVER_CHANGE_ARCHIVED_STATUS:"server_change_archived_status",SERVER_SEARCH:"server_search",CLIENT_CHANGE_MUTE_SETTINGS:"client_change_mute_settings",SERVER_UNREAD_THREADS:"server_unread_threads",SERVER_MARK_SEEN:"server_mark_seen",SERVER_THREAD_SYNC:"server_thread_sync",CLIENT_DELETE_MESSAGES:"client_delete_messages",SERVER_FETCH_THREADLIST_INFO:"server_fetch_threadlist_info",CLIENT_CHANNEL_MESSAGE:"client_channel_message",CLIENT_CHANGE_FOLDER:"client_change_folder",CLIENT_CHANGE_READ_STATUS:"client_change_read_status",CLIENT_CLEAR_CHAT:"client_clear_chat",SERVER_FETCH_THREAD_INFO:"server_fetch_thread_info",SERVER_CHANGE_READ_STATUS:"server_change_read_status",SERVER_SEND_MESSAGE:"server_send_message",CLIENT_SAVE_DRAFT:"client_save_draft",UNKNOWN:"unknown",SERVER_MARK_FOLDER_READ:"server_mark_folder_read",SERVER_CONFIRM_MESSAGES:"server_confirm_messages",SERVER_TAB_PRESENCE:"server_tab_presence",CLIENT_CHANGE_ARCHIVED_STATUS:"client_change-archived_status",CLIENT_SEND_MESSAGE:"client_send_message",CLIENT_HANDLE_ERROR:"client_handle_error"};});
__d("MercurySourceType",[],function(a,b,c,d,e,f){e.exports={TITAN_FACEWEB_BUFFY:"source:titan:faceweb_buffy",WEBRTC_MOBILE:"source:webrtc:mobile",GIGABOXX_API:"source:gigaboxx:api",TITAN_M_JAPAN:"source:titan:m_japan",BUFFY_SMS:"source:buffy:sms",SEND_PLUGIN:"source:sendplugin",CHAT_MEEBO:"source:chat:meebo",TITAN_FACEWEB_IPAD:"source:titan:faceweb_ipad",TITAN_FACEWEB_IPHONE:"source:titan:faceweb_iphone",TEST:"source:test",TITAN_API_MOBILE:"source:titan:api_mobile",TITAN_EMAIL_REPLY:"source:titan:emailreply",TITAN_FACEWEB_ANDROID:"source:titan:faceweb_android",TITAN_ORCA:"source:titan:orca",TITAN_M_TOUCH:"source:titan:m_touch",CHAT:"source:chat",CHAT_IPHONE:"source:chat:iphone",TITAN_WEB:"source:titan:web",UNKNOWN:"source:unknown",TITAN_M_MINI:"source:titan:m_mini",GIGABOXX_MOBILE:"source:gigaboxx:mobile",HELPCENTER:"source:helpcenter",PAID_PROMOTION:"source:paid_promotion",GIGABOXX_EMAIL_REPLY:"source:gigaboxx:emailreply",TITAN_M_TALK:"source:titan:m_talk",GIGABOXX_BLAST:"source:gigaboxx:blast",TITAN_FACEWEB_UNKNOWN:"source:titan:faceweb_unknown",CHAT_WEB:"source:chat:web",TITAN_M_TABLET:"source:titan:m_tablet",WEB:"source:web",SOCIALFOX:"source:socialfox",EMAIL:"source:email",TITAN_API:"source:titan:api",GIGABOXX_WEB:"source:gigaboxx:web",DESKTOP:"source:desktop",LEIA:"source:leia",CHAT_JABBER:"source:chat:jabber",CHAT_TEST:"source:chat:test",SHARE_DIALOG:"source:share:dialog",GIGABOXX_WAP:"source:gigaboxx:wap",MOBILE:"source:mobile",TITAN_M_APP:"source:titan:m_app",TITAN_WAP:"source:titan:wap",SMS:"source:sms",TITAN_M_BASIC:"source:titan:m_basic",TITAN_M_ZERO:"source:titan:m_zero",NEW_SHARE_DIALOG:"source:share:dialog:new",CHAT_ORCA:"source:chat:orca"};});
__d("MercuryThreadMode",[],function(a,b,c,d,e,f){e.exports={EMAIL_ORIGINATED:1,OBJECT_ORIGINATED:3,TITAN_ORIGINATED:2};});
__d("MessagingTag",[],function(a,b,c,d,e,f){e.exports={MTA_SYSTEM_MESSAGE:"MTA:system_message",SENT:"sent",INBOX:"inbox",SMS_TAG_ROOT:"SMSShortcode:",UPDATES:"broadcasts_inbox",OTHER:"other",GROUPS:"groups",FILTERED_CONTENT:"filtered_content",ACTION_ARCHIVED:"action:archived",UNREAD:"unread",BCC:"header:bcc",SMS_MUTE:"sms_mute",ARCHIVED:"archived",DOMAIN_AUTH_PASS:"MTA:dmarc:pass",EVENT:"event",VOICEMAIL:"voicemail",DOMAIN_AUTH_FAIL:"MTA:dmarc:fail",SPAM_SPOOFING:"spam:spoofing",SPOOF_WARNING:"MTA:spoof_warning",SPAM:"spam",EMAIL_MESSAGE:"source:email",EMAIL:"email",APP_ID_ROOT:"app_id:"};});
__d("PhotoResizeModeConst",[],function(a,b,c,d,e,f){e.exports={CONTAIN:"s",COVER:"p"};});
__d("AvailableListConstants",["fbt"],function(a,b,c,d,e,f){var g=b('fbt'),h={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',ON_CHAT_NOTIFICATION_CHANGED:'chat-notification-changed',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,WEB_STATUS:'webStatus',FB_APP_STATUS:'fbAppStatus',MESSENGER_STATUS:'messengerStatus',OTHER_STATUS:'otherStatus',ACTIVE_ON_WEB:"Web",ACTIVE_ON_MOBILE:"Mobile",LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,STATUS_ACTIVE:'active',STATUS_IDLE:'idle',STATUS_OFFLINE:'offline',legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};a.AvailableListConstants=e.exports=h;});
__d("LastMobileActiveTimes",["ServerTime","tx"],function(a,b,c,d,e,f){var g=b('ServerTime'),h=b('tx'),i={};function j(n){if(!n||n<0)return '';var o=(g.get()/1000)-n,p=Math.floor(o/60),q=Math.floor(p/60),r=Math.floor(q/24);if(p<=1){return h._("{count}m",{count:1});}else if(p<60){return h._("{count}m",{count:p});}else if(q<24){return h._("{count}h",{count:q});}else if(r<3){return h._("{count}d",{count:r});}else return '';}function k(n,o){i[n]=o;}function l(n){if(n in i){return i[n];}else return 0;}var m={update:function(n){for(var o in n)k(o,n[o]);},getShortDisplay:function(n){return j(l(n));}};e.exports=m;});
__d("SplitImage.react",["React","Image.react","cx"],function(a,b,c,d,e,f){var g=b('React'),h=b('Image.react'),i=b('cx'),j=g.createClass({displayName:'SplitImage',render:function(){var k=this.props.size;return this.transferPropsTo(g.DOM.div({className:"_55lt",style:{width:k,height:k}},this.renderImages()));},renderImages:function(){if(!this.props.srcs)return null;var k=this.props.srcs,l=Array.isArray(k);if(!l||k.length==1)return this.renderOne(l?k[0]:k);return k.length==2?this.renderTwo(k):this.renderThree(k);},renderOne:function(k){return (h({src:k,width:this.props.size,height:this.props.size}));},renderTwo:function(k){var l=this.props.size,m=Math.floor(l/2),n=-Math.floor(m/2),o=(("_55lu")+(this.props.border?' '+"_57xo":''));return (g.DOM.div(null,g.DOM.div({className:"_55lu",style:{width:m}},h({src:k[0],width:l,height:l,style:{marginLeft:n}})),g.DOM.div({className:o,style:{width:m}},h({src:k[1],width:l,height:l,style:{marginLeft:n}}))));},renderThree:function(k){var l=this.props.size,m=Math.floor(l/3*2),n=-Math.floor((l-m)/2),o=Math.floor(l/2),p=l-m,q=-Math.floor((o-p)/2),r=(("_55lu")+(this.props.border?' '+"_57pl":'')),s=(("_55lu")+(this.props.border?' '+"_57pm":''));return (g.DOM.div(null,g.DOM.div({className:r,style:{width:m}},h({src:k[0],width:l,height:l,style:{marginLeft:n}})),g.DOM.div({className:s,style:{width:p,height:o}},h({src:k[1],width:o,height:o,style:{marginLeft:q}})),g.DOM.div({className:"_55lu",style:{width:p,height:o}},h({src:k[2],width:o,height:o,style:{marginLeft:q}}))));}});e.exports=j;});
__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._error=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);this._error=null;}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._error=null;this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;var m=this._resources.indexOf(l);if(m!=-1)this._resources.splice(m,1);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._error=null;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},setError:function(k){if(this._error!==k){this._error=k;this._controller.runPossibleCallbacks();}},getError:function(k,l,m){var n=this._filterForStrictResults({strict:m});return k+l>n.length?this._error:null;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&!this._error&&k.start+k.limit>m.length){return false;}else{var n=m.slice(k.start,k.start+k.limit),o=k.start+k.limit>m.length?this._error:null;return [n,o];}},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("escapeRegex",[],function(a,b,c,d,e,f){function g(h){return h.replace(/([.?*+\^$\[\]\\(){}|\-])/g,"\\$1");}e.exports=g;});
__d("mergeObjects",["copyProperties"],function(a,b,c,d,e,f){var g=b('copyProperties');function h(){var i={};for(var j=0;j<arguments.length;j++)g(i,arguments[j]);return i;}e.exports=h;});
__d("ReportState",["ErrorUtils","invariant"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('invariant'),i={};function j(l,m){h(!i[l]);i[l]=m;}function k(){var l={};Object.keys(i).forEach(function(m){try{l[m]=i[m]();}catch(n){g.reportError('ReportState: callback threw an error.');}});return l;}e.exports={registerCallback:j,getState:k};});
__d("PresenceUtil",["Cookie","Session","randomInt"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Session'),i=b('randomInt'),j=i(0,4294967295)+1;function k(){return j;}function l(){return h.userID===g.get('c_user');}e.exports={getSessionID:k,hasUserCookie:l};});
__d("WebMessengerEvents",["Arbiter","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=h(new g(),{MASTER_DOM_CHANGED:'master-dom-changed',DETAIL_DOM_CHANGED:'detail-dom-changed',FOCUS_COMPOSER:'focus-composer',FOCUS_SEARCH:'focus-search',FOCUS_AND_SELECT_SEARCH:'focus-and-select-search',SUBMIT_REPLY:'submit-reply',UPDATE_SELECTION:'update-selection',masterDOMChanged:function(){this.inform(i.MASTER_DOM_CHANGED);},detailDOMChanged:function(){this.inform(i.DETAIL_DOM_CHANGED);},focusComposer:function(){this.inform(i.FOCUS_COMPOSER);},focusSearch:function(){this.inform(i.FOCUS_SEARCH);},focusAndSelectSearch:function(){this.inform(i.FOCUS_AND_SELECT_SEARCH);},updateSelection:function(j){this.inform(i.UPDATE_SELECTION,j);},submitReply:function(){this.inform(i.SUBMIT_REPLY);}});e.exports=i;});
__d("WebMessengerSubscriptionsHandler",["SubscriptionsHandler"],function(a,b,c,d,e,f){var g=b('SubscriptionsHandler'),h=new g('webmessenger');e.exports=h;});
__d("isWebMessengerURI",[],function(a,b,c,d,e,f){function g(h){return (/^(\/messages)/).test(h.getPath());}e.exports=g;});
__d("WebMessengerWidthControl",["Arbiter","CSS","CSSClassTransition","DOMDimensions","Event","Style","URI","ViewportBounds","WebMessengerEvents","WebMessengerSubscriptionsHandler","$","cx","isWebMessengerURI","requestAnimationFrame","setTimeoutAcrossTransitions","shield","throttle"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('CSS'),i=b('CSSClassTransition'),j=b('DOMDimensions'),k=b('Event'),l=b('Style'),m=b('URI'),n=b('ViewportBounds'),o=b('WebMessengerEvents'),p=b('WebMessengerSubscriptionsHandler'),q=b('$'),r=b('cx'),s=b('isWebMessengerURI'),t=b('requestAnimationFrame'),u=b('setTimeoutAcrossTransitions'),v=b('shield'),w=b('throttle'),x=205,y=981,z=257,aa=18,ba=848,ca=724,da=.57,ea=56,fa,ga,ha;function ia(na,oa,pa){this.masterChanged=na;this.detailChaned=oa;p.addSubscriptions(k.listen(window,'resize',w(v(ja,this,this),100)),g.subscribe(['sidebar/initialized','sidebar/show','sidebar/hide'],v(ja,this,this),g.SUBSCRIBE_NEW));var qa=ma()?ea:0;if(pa)qa=x;this._width=ma()?0:ba;ha=true;ja(this,qa);}function ja(na,oa){var pa=n.getRight()+n.getLeft();pa=pa||oa||0;var qa=j.getViewportWithoutScrollbarDimensions().width-pa,ra=Math.round(Math.max(0,qa/2-y/2));qa=y+ra-z;qa-=aa;qa=Math.max(ca,Math.min(ba,qa));if(!isNaN(qa)&&na._width!==qa){na._width=qa;var sa=Math.round(qa/(1+da)),ta=qa-sa;na.masterChanged(ta);na.detailChaned(sa);if(ma()){var ua=qa+z;ka(function(){if(ga){document.body.className=ga;ga='';}la(ua+'px');h.removeClass(document.body,"_5262");ha&&o.detailDOMChanged();ha=false;},ga);}}}function ka(na,oa){oa&&h.addClass(document.documentElement,"_5261");t(na);oa&&u(h.removeClass.bind(null,document.documentElement,"_5261"),1000);}function la(na){l.set(q('pageHead'),'width',na);l.set(q('globalContainer'),'width',na);}function ma(){if(!fa)fa=h.hasClass(document.body,"_6nw");return fa;}i.registerHandler(function(na,oa,pa,qa){function ra(sa){return ma()&&s(m(sa));}if(ra(qa)){ga=oa;return true;}else if(ra(pa)){ka(function(){na.className=oa;la('');},true);return true;}});e.exports=ia;});
__d("WebMessengerPermalinkConstants",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',overriddenVanities:'(archived|other|spam|new|search|conversation-.*)',getURIPathForThreadID:function(i,j){return (j||h.BASE_PATH)+h.TID_POSTFIX_PARTIAL_PATH+g.encodeComponent(g.encodeComponent(i));},getThreadIDFromURI:function(i){var j=i.getPath().match(h.BASE_PATH+'(/[^/]*)*'+h.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(j){var k=g.decodeComponent(g.decodeComponent(j[2]));return k;}},getURIPathForIDOrVanity:function(i,j){if(i.match('^'+h.overriddenVanities+'$'))i='.'+i;return (j||h.BASE_PATH)+'/'+i;},getUserIDOrVanity:function(i){var j=i.match(h.BASE_PATH+'.*/([^/]+)/?$'),k=j&&j[1],l=h.overriddenVanities;if(!k||k.match('^'+l+'$')){return false;}else if(k.match('^\\.'+l+'$')){return k.substr(1);}else return k;}};e.exports=h;});
__d("MercuryErrorInfo",["MercuryErrorType","tx"],function(a,b,c,d,e,f){var g=b('MercuryErrorType'),h=b('tx'),i={getMessage:function(j){var k="This message failed to send.";if(i.isConnectionError(j)){k="Unable to connect to Facebook. This message failed to send. ";}else if(j.description)k=j.description;return k;},isConnectionError:function(j){if(j&&j.type==g.TRANSPORT)return j.code===1001||j.code===1004||j.code===1006;return false;},isTransient:function(j){return j&&j.is_transient;},isPermanent:function(j){return j?!this.isTransient(j):false;}};e.exports=i;});
__d("MercurySingletonMixin",["CurrentUser"],function(a,b,c,d,e,f){var g={_getInstances:function(){if(!this._instances)this._instances={};return this._instances;},get:function(){return this.getForFBID(h.getID());},getForFBID:function(i){var j=this._getInstances();if(!j[i])j[i]=new this(i);return j[i];}};e.exports=g;var h=b('CurrentUser');});
__d("MercuryMessageClientState",[],function(a,b,c,d,e,f){var g={DO_NOT_SEND_TO_SERVER:'do_not_send_to_server',SEND_TO_SERVER:'send_to_server'};e.exports=g;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("MercuryFilters",["MessagingTag","arrayContains"],function(a,b,c,d,e,f){var g=b('MessagingTag'),h=b('arrayContains'),i=[g.UNREAD],j={ALL:'all',getSupportedFilters:function(){return i.concat();},isSupportedFilter:function(k){return h(i,k);}};e.exports=j;});
__d("MercuryFolders",["MessagingTag","arrayContains"],function(a,b,c,d,e,f){var g=b('MessagingTag'),h=b('arrayContains'),i=[g.INBOX,g.OTHER,g.ACTION_ARCHIVED,g.SPAM],j={getSupportedFolders:function(){return i.concat();},isSupportedFolder:function(k){return h(i,k);},getFromMeta:function(k){var l=k.folder;if(k.is_archived)l=g.ACTION_ARCHIVED;return l;}};e.exports=j;});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(i){return typeof i==='string'&&i.indexOf(':')!==-1;}var h={isValid:function(i){if(!i)return false;return g(i);},isValidThreadID:function(i){if(!h.isValid(i))return false;var j=h.tokenize(i);switch(j.type){case 'user':case 'group':case 'thread':case 'root':case 'pending':return true;default:return false;}},tokenize:function(i){if(!this.isValid(i))throw 'bad_id_format';var j=i.indexOf(':');return {type:i.substr(0,j),value:i.substr(j+1)};},getUserIDFromParticipantID:function(i){if(!h.isValid(i))return null;var j=h.tokenize(i);if(j.type!='fbid')return null;return j.value;},isMultichat:function(i){return this.tokenize(i).type!=='user';}};e.exports=h;});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("XMercurySendLogControllerURIBuilder",["XControllerURIBuilder"],function(a,b,c,d,e,f){var g=b('XControllerURIBuilder');e.exports=g.create("\/messaging\/send_logger\/",{is_canonical:{type:"Bool"},message_id:{type:"String",required:true},event:{type:"Enum",required:true}});});
__d("MercurySendLogger",["AsyncSignal","XMercurySendLogControllerURIBuilder"],function(a,b,c,d,e,f){var g=b('AsyncSignal'),h=b('XMercurySendLogControllerURIBuilder'),i=false,j={CLIENT_SEND_ATTEMPTED:'client_send_attempted',CLIENT_RESEND_ATTEMPTED:'client_resend_attempted',CLIENT_SEND_SUCCEEDED:'client_send_succeeded',CLIENT_SEND_FAILED:'client_send_failed',CLIENT_CHANNEL_ECHO:'client_channel_echo',enable:function(){i=true;},log:function(event,k,l){if(!i)return;new g((new h()).setEnum('event',event).setString('message_id',k).setBool('is_canonical',!!l.canonical).getURI().toString()).send();}};e.exports=j;});
__d("MessagingReliabilityLogger",["PresenceUtil","MercuryServerDispatcher","MessagingReliabilityLoggerInitialData","isEmpty","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){var g=b('PresenceUtil'),h=b('MercuryServerDispatcher'),i=b('MessagingReliabilityLoggerInitialData'),j=b('isEmpty'),k=b('setTimeoutAcrossTransitions'),l='/ajax/mercury/client_reliability.php',m=60000;function n(t,u){var v={app:i.app,categories:JSON.stringify(t)};if(!j(u))v.extra=JSON.stringify(u);return v;}function o(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=0;t[u][v]+=w;}function p(t,u,v,w){if(t[u]===undefined)t[u]={};if(t[u][v]===undefined)t[u][v]=[];for(var x=0;x<w.length;++x)t[u][v].push(w[x]);}function q(t,u){if((t&&!t.categories)||(u&&!u.categories))return;var v=t?JSON.parse(t.categories):{},w=t&&t.extra?JSON.parse(t.extra):{},x=JSON.parse(u.categories),y=u.extra?JSON.parse(u.extra):{};for(var z in x){var aa=x[z],ba=y[z];for(var ca in aa){o(v,z,ca,aa[ca]);if(ba!==undefined){var da=ba[ca];if(da!==undefined)p(w,z,ca,da);}}}return n(v,w);}var r={};r[l]={mode:h.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:q};h.registerEndpoints(r);var s={addEntry:function(t,u,v){if(!i.enabled)return;var w={};o(w,t,u,1);var x={};if(v!==undefined)p(x,t,u,[v]);h.trySend(l,n(w,x));}};(function t(){s.addEntry('page_event','active',g.getSessionID());k(t,m);})();e.exports=s;});
__d("MercuryThreadInformer",["ArbiterMixin","copyProperties","MercuryAssert","MercurySingletonMixin"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('copyProperties'),i=b('MercuryAssert'),j=b('MercurySingletonMixin');function k(m){if(!m._locked){var n=m._threadDeletions,o=m._threadChanges,p=m._threadReadChanges,q=m._threadlistChanged,r=m._unseenStateChanged,s=m._unreadStateChanged,t=m._receivedMessages,u=m._reorderedMessages,v=m._updatedMessages;m._threadDeletions={};m._threadChanges={};m._threadReadChanges={};m._threadlistChanged=false;m._unseenStateChanged=false;m._unreadStateChanged=false;m._receivedMessages={};m._reorderedMessages={};m._updatedMessages={};var w=Object.keys(o);if(w.length||q)m.inform('threadlist-updated',w);if(w.length)m.inform('threads-updated',o);for(var x in p){m.inform('thread-read-changed',p);break;}for(var x in n){m.inform('threads-deleted',n);break;}if(r)m.inform('unseen-updated',null);if(s)m.inform('unread-updated',null);for(x in t){m.inform('messages-received',t);break;}for(x in u){m.inform('messages-reordered',u);break;}for(x in v){m.inform('messages-updated',v);break;}}}function l(m){this._fbid=m;this._threadDeletions={};this._threadChanges={};this._threadReadChanges={};this._threadlistChanged=false;this._unseenStateChanged=false;this._unreadStateChanged=false;this._receivedMessages={};this._reorderedMessages={};this._updatedMessages={};this._locked=0;}h(l.prototype,g,{updatedThread:function(m){this._threadChanges[m]=true;k(this);},deletedThread:function(m){this._threadDeletions[m]=true;k(this);},updatedThreadlist:function(){this._threadlistChanged=true;k(this);},updatedUnseenState:function(){this._unseenStateChanged=true;k(this);},updatedUnreadState:function(){this._unreadStateChanged=true;k(this);},changedThreadReadState:function(m,n,o){if(!this._threadReadChanges[m]||this._threadReadChanges[m].timestamp<o)this._threadReadChanges[m]={mark_as_read:n,timestamp:o};k(this);},receivedMessage:function(m){i.isThreadID(m.thread_id);var n=m.thread_id;if(!this._receivedMessages[n])this._receivedMessages[n]=[];this._receivedMessages[n].push(m);this.updatedThread(n);},reorderedMessages:function(m,n){this._reorderedMessages[m]={source:n};k(this);},updatedMessage:function(m,n,o){if(!this._updatedMessages[m])this._updatedMessages[m]={};this._updatedMessages[m][n]={source:o};this.updatedThread(m);},synchronizeInforms:function(m){this._locked++;try{m();}catch(n){throw n;}finally{this._locked--;k(this);}},listen:function(m,n){return this.subscribe('threads-updated',function(o,p){if(p[m])n(m);});}});h(l,j);e.exports=l;});
__d("MercuryServerRequests",["ArbiterMixin","AsyncResponse","TimestampConverter","CurrentUser","KeyedCallbackManager","LogHistory","MercuryActionStatus","MercuryActionTypeConstants","MercuryAPIArgsSource","MercuryAssert","MercuryErrorType","MercuryGenericConstants","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercuryMessageClientState","MercuryPayloadSource","MercurySendLogger","MercuryServerRequestsConfig","MercurySingletonMixin","MercurySourceType","MercuryThreadlistConstants","MercuryMessageIDs","MessagingConfig","MessagingReliabilityLogger","MessagingTag","MercuryServerDispatcher","MercuryThreadInformer","copyProperties","createObjectFrom","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){"use strict";var g=b('ArbiterMixin'),h=b('AsyncResponse'),i=b('TimestampConverter'),j=b('CurrentUser'),k=b('KeyedCallbackManager'),l=b('LogHistory'),m=b('MercuryActionStatus'),n=b('MercuryActionTypeConstants'),o=b('MercuryAPIArgsSource'),p=b('MercuryAssert'),q=b('MercuryErrorType'),r=b('MercuryGenericConstants'),s=b('MercuryGlobalActionType'),t=b('MercuryIDs'),u=b('MercuryLogMessageType'),v=b('MercuryMessageClientState'),w=b('MercuryPayloadSource'),x=b('MercurySendLogger'),y=b('MercuryServerRequestsConfig'),z=b('MercurySingletonMixin'),aa=b('MercurySourceType'),ba=b('MercuryThreadlistConstants'),ca=b('MercuryMessageIDs'),da=b('MessagingConfig'),ea=b('MessagingReliabilityLogger'),fa=b('MessagingTag'),ga=b('MercuryServerDispatcher'),ha=b('MercuryThreadInformer'),ia=b('copyProperties'),ja=b('createObjectFrom'),ka=b('setTimeoutAcrossTransitions'),la=l.getInstance('mercury_server'),ma=o.MERCURY;function na(vb,wb){if(wb)vb._lastActionId=i.maxValidActionID(vb._lastActionId,wb);}function oa(vb,wb){var xb=wb.thread_id,yb=vb._serverToClientIDs.getResource(xb);if(!yb){if(wb.canonical_fbid){yb='user:'+wb.canonical_fbid;}else if(wb.root_message_threading_id)yb='root:'+wb.root_message_threading_id;yb=yb||'thread:'+xb;pa(vb,xb,yb);}wb.thread_id=yb;}function pa(vb,wb,xb){vb._serverToClientIDs.setResource(wb,xb);vb._clientToServerIDs.setResource(xb,wb);vb._newlyAddedClientIDs[wb]=xb;}function qa(vb,wb,xb){var yb=vb._clientToServerIDs.executeOrEnqueue(wb,xb),zb=vb._clientToServerIDs.getUnavailableResources(yb),ac=vb.tokenizeThreadID(wb);if(zb.length&&ac.type!='root')vb.fetchThreadData(zb);}function ra(vb,wb){return vb._clientToServerIDs.getResource(wb);}function sa(vb,wb){return !!vb._serverToClientIDs.getResource(wb);}function ta(vb,wb){var xb=vb._serverToClientIDs.getResource(wb);if(typeof xb=='undefined')la.warn('no_client_thread_id',{server_id:wb});return xb;}function ua(vb,wb,xb){vb._serverToClientIDs.executeOrEnqueue(wb,xb);vb.ensureThreadIsFetched(wb);}function va(vb,wb,xb){if(wb.action_type!=n.SEND_MESSAGE)return;var yb=wb.client_thread_id;if(!yb)yb=ta(vb,wb.thread_id);var zb=null;if(yb)zb=t.tokenize(yb).type;ea.addEntry('send_'+zb,xb,wb.thread_id+','+wb.message_id);x.log(xb==='success'?x.CLIENT_SEND_SUCCEEDED:x.CLIENT_SEND_FAILED,wb.client_message_id,{canonical:zb&&!t.isMultichat(yb)});}function wa(vb){return vb.getError()?'_'+vb.getError():'';}function xa(vb,wb){var xb=null;switch(wb.status){case m.SUCCESS:xb='success';break;case m.FAILED_UNKNOWN_REASON:xb='confirmed_error';break;case m.UNABLE_TO_CONFIRM:xb='confirm_error';break;default:return;}va(vb,wb,xb);}function ya(vb,wb){(wb.message_counts||[]).forEach(function(fc){na(vb,fc.last_action_id);});(wb.threads||[]).forEach(function(fc){oa(vb,fc);delete vb._fetchingThreads[fc.thread_id];var gc=ra(vb,fc.thread_id);delete vb._fetchingThreads[gc];na(vb,fc.last_action_id);});(wb.ordered_threadlists||[]).forEach(function(fc){fc.thread_ids=fc.thread_ids.map(ta.bind(null,vb));});wb.actions=wb.actions||[];wb.actions.forEach(function(fc){xa(vb,fc);if(fc.status&&fc.status!=m.SUCCESS&&!fc.thread_id){fc.thread_id=fc.client_thread_id;return;}if(fc.action_type==n.SEND_MESSAGE&&fc.client_thread_id&&fc.client_thread_id!=r.PENDING_THREAD_ID)pa(vb,fc.thread_id,fc.client_thread_id);fc.server_thread_id=fc.thread_id;fc.thread_id=sa(vb,fc.thread_id)?ta(vb,fc.thread_id):null;na(vb,fc.action_id);});if(wb.end_of_history){var xb=[];for(var yb=0;yb<wb.end_of_history.length;yb++){var zb=wb.end_of_history[yb];if(zb.type=='user'){xb.push('user:'+zb.id);}else if(zb.type=='thread'&&sa(vb,zb.id))xb.push(ta(vb,zb.id));}wb.end_of_history=xb;}if(wb.roger){var ac={};for(var bc in wb.roger){var cc=vb._serverToClientIDs.getResource(bc);if(cc){var dc=wb.roger[bc];ac[cc]={};for(var ec in dc)ac[cc]['fbid:'+ec]=dc[ec];}}wb.roger=ac;}}function za(vb){if(vb._pendingUpdates&&vb._pendingUpdates.length){var wb=vb._pendingUpdates[0];vb._pendingUpdates=vb._pendingUpdates.slice(1);vb.handleUpdate(wb);}}function ab(vb,wb){var xb=ia({},vb),yb;if(wb.threads){if(!xb.threads)xb.threads={};for(yb in wb.threads)xb.threads[yb]=Object.keys(ja((xb.threads[yb]||[]).concat(wb.threads[yb])));}if(wb.messages){if(!xb.messages)xb.messages={};for(yb in wb.messages){if(!xb.messages[yb])xb.messages[yb]={};for(var zb in wb.messages[yb])if(xb.messages[yb][zb]){xb.messages[yb][zb]=db(xb.messages[yb][zb],wb.messages[yb][zb]);}else xb.messages[yb][zb]=wb.messages[yb][zb];}}xb.client=vb.client||wb.client;return xb;}function bb(vb,wb){var xb=ia(ja(vb.folders,true),ja(wb.folders,true)),yb=vb.client||wb.client;return {folders:Object.keys(xb),client:yb};}function cb(vb,wb){for(var xb in wb)if(vb[xb]&&typeof vb[xb]==='object'){vb[xb]=db(vb[xb],wb[xb]);}else if(wb[xb]&&typeof wb[xb]==='object'){var yb={};ia(yb,wb[xb]);vb[xb]=yb;}return vb;}function db(vb,wb){var xb=vb.offset<wb.offset?vb.offset:wb.offset,yb=vb.offset+vb.limit,zb=wb.offset+wb.limit,ac=(yb>zb)?yb:zb,bc=ac-xb;return {offset:xb,limit:bc};}function eb(vb,wb){var xb=vb.client||wb.client,yb={ids:{},client:xb};ia(yb.ids,vb.ids);ia(yb.ids,wb.ids);return yb;}function fb(vb,wb){var xb={},yb,zb=vb.client||wb.client;delete vb.client;delete wb.client;for(yb in vb)ia(xb,ja(vb[yb],yb));for(yb in wb)ia(xb,ja(wb[yb],yb));var ac={client:zb};for(var bc in xb){yb=xb[bc];if(!ac[yb])ac[yb]=[];ac[yb].push(bc);}return ac;}function gb(vb,wb){var xb=vb.client||wb.client,yb=ja(vb.ids,true),zb=ja(wb.ids,true),ac=ia(yb,zb);return {ids:Object.keys(ac),client:xb};}function hb(vb){this._fbid=vb;this._lastActionId=0;this._serverToClientIDs=new k();this._clientToServerIDs=new k();this._pendingUpdates=[];this._fetchingThreads={};this._newlyAddedClientIDs={};tb(this);}ia(hb.prototype,g,{tokenizeThreadID:function(vb){p.isThreadID(vb);return t.tokenize(vb);},getServerThreadID:function(vb,wb){p.isThreadID(vb);qa(this,vb,wb);},getClientThreadID:function(vb,wb){ua(this,vb,wb);},getClientThreadIDNow:function(vb){return ta(this,vb);},getServerThreadIDNow:function(vb){return ra(this,vb);},convertThreadIDIfAvailable:function(vb){var wb=this._serverToClientIDs.getResource(vb);if(wb===undefined){return vb;}else return wb;},canLinkExternally:function(vb){p.isThreadID(vb);var wb=this.tokenizeThreadID(vb);return (wb.type=='user')||!!ra(this,vb);},fetchThreadlistInfo:function(vb,wb,xb,yb,zb){xb=xb||fa.INBOX;zb=zb||ma;var ac=yb?ga.IMMEDIATE:null,bc={client:zb};bc[xb]={offset:vb,limit:wb,filter:yb};ub(this,'/ajax/mercury/threadlist_info.php',bc,ac);},fetchUnseenThreadIDs:function(vb,wb){wb=wb||ma;this.fetchThreadlistInfo(ba.RECENT_THREAD_OFFSET,ba.JEWEL_THREAD_COUNT,vb,null,wb);},fetchUnreadThreadIDs:function(vb,wb){wb=wb||ma;ub(this,'/ajax/mercury/unread_threads.php',{folders:[vb],client:wb});},fetchMissedMessages:function(vb,wb){wb=wb||ma;ub(this,'/ajax/mercury/thread_sync.php',{last_action_id:this._lastActionId,folders:vb,client:wb});},fetchThreadData:function(vb,wb){wb=wb||ma;p.allThreadID(vb);var xb={threads:{},client:wb},yb=[],zb=[];vb.forEach(function(bc){if(this._fetchingThreads[bc])return;this._fetchingThreads[bc]=true;var cc=ra(this,bc);if(cc){zb.push(cc);xb.threads.thread_ids=zb;}else{var dc=this.tokenizeThreadID(bc);if(dc.type=='user'){yb.push(dc.value);xb.threads.user_ids=yb;}else if(dc.type=='thread'){zb.push(dc.value);xb.threads.thread_ids=zb;}else if(dc.type!='root'&&dc.type!='pending')throw new Error('Unknown thread type',dc);}}.bind(this));this.inform("fetch-thread-data",xb);for(var ac in xb.threads){ub(this,'/ajax/mercury/thread_info.php',xb);break;}},ensureThreadIsFetched:function(vb,wb){wb=wb||ma;if(!this._serverToClientIDs.getResource(vb)&&!this._fetchingThreads[vb]){this._fetchingThreads[vb]=true;ub(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[vb]},client:wb});}},fetchThreadMessages:function(vb,wb,xb,yb,zb){p.isThreadID(vb);zb=zb||ma;var ac,bc,cc=this.tokenizeThreadID(vb),dc=ra(this,vb),ec=false;if(dc&&cc.type!='group'){bc='thread_ids';ac=dc;}else{ac=cc.value;switch(cc.type){case 'user':bc='user_ids';ec=true;break;case 'group':bc='group_ids';break;case 'thread':bc='thread_ids';break;}}var fc={messages:{},threads:{},client:zb};if(bc){fc.messages[bc]={};fc.messages[bc][ac]={offset:wb,limit:xb};if(ec)fc.threads[bc]=[ac];ub(this,'/ajax/mercury/thread_info.php',fc,yb);}else qa(this,vb,function(gc){fc.messages.thread_ids={};fc.messages.thread_ids[gc]={offset:wb,limit:xb};ub(this,'/ajax/mercury/thread_info.php',fc,yb);}.bind(this));},handleThreadInfoError:function(vb){var wb=vb.getRequest().getData(),xb=[];if(wb.messages){for(var yb in wb.messages.thread_ids)xb.push(ib(ta(this,yb)));for(var zb in wb.messages.user_ids)xb.push(ib('user:'+zb));for(var ac in wb.messages.group_ids)xb.push(ib('group:'+ac));}if(xb.length)this.handleUpdate({actions:xb,from_client:true,payload_source:w.CLIENT_CHANNEL_MESSAGE});if(wb.threads&&(wb.threads.user_ids||wb.threads.group_ids||wb.threads.thread_ids)){var bc=5,cc=true;if(!wb.retry_count){wb.retry_count=0;if(wb.messages)delete wb.messages;}else if(wb.retry_count>=bc){cc=false;(wb.threads.thread_ids||[]).forEach(function(ec){if(ec in this._fetchingThreads)delete this._fetchingThreads[ec];}.bind(this));}if(cc){var dc=wb.retry_count*1000;ka(function(){la.log('retry_thread',wb);ub(this,'/ajax/mercury/thread_info.php',wb);}.bind(this),dc);wb.retry_count++;}}},markFolderAsRead:function(vb){ub(this,'/ajax/mercury/mark_folder_as_read.php',{folder:vb});var wb=[{action_type:s.MARK_ALL_READ,action_id:null,folder:vb}];this.handleUpdate({global_actions:wb,from_client:true,payload_source:w.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(vb,wb,xb){p.isThreadID(vb);qa(this,vb,function(zb){var ac={ids:{}};ac.ids[zb]=wb;ub(this,'/ajax/mercury/change_read_status.php',ac);}.bind(this));var yb=[{action_type:n.CHANGE_READ_STATUS,action_id:null,thread_id:vb,mark_as_read:wb,folder:xb}];this.handleUpdate({actions:yb,from_client:true,payload_source:w.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(vb,wb){p.isThreadID(vb);qa(this,vb,function(zb){var ac={ids:{}};ac.ids[zb]=wb;ub(this,'/ajax/mercury/change_archived_status.php',ac);}.bind(this));var xb={action_type:n.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:vb,archived:wb},yb={actions:[xb],from_client:true,payload_source:w.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(yb);},changeThreadFolder:function(vb,wb){p.isThreadID(vb);qa(this,vb,function(zb){var ac={};ac[wb]=[zb];ub(this,'/ajax/mercury/move_thread.php',ac);}.bind(this));var xb={action_type:n.CHANGE_FOLDER,action_id:null,thread_id:vb,new_folder:wb},yb={actions:[xb],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(yb);},changeMutingOnThread:function(vb,wb){p.isThreadID(vb);qa(this,vb,function(zb){ub(this,'/ajax/mercury/change_mute_thread.php',{thread_id:zb,mute_settings:wb,payload_source:ma});}.bind(this));var xb={action_type:n.CHANGE_MUTE_SETTINGS,action_id:null,thread_id:vb,mute_settings:wb},yb={actions:[xb],from_client:true,payload_source:w.CLIENT_CHANGE_MUTE_SETTINGS};this.handleUpdate(yb);},markThreadSpam:function(vb){p.isThreadID(vb);qa(this,vb,function(yb){ub(this,'/ajax/mercury/mark_spam.php',{id:yb});}.bind(this));var wb={action_type:n.CHANGE_FOLDER,action_id:null,thread_id:vb,new_folder:fa.SPAM},xb={actions:[wb],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(xb);},markMessagesSpam:function(vb,wb){ca.getServerIDs(wb||[],function(yb){ub(this,'/ajax/mercury/mark_spam_messages.php',{message_ids:yb});}.bind(this));var xb={action_type:n.DELETE_MESSAGES,action_id:null,thread_id:vb,message_ids:wb};this.handleUpdate({actions:[xb],from_client:true,payload_source:w.CLIENT_DELETE_MESSAGES});},unmarkThreadSpam:function(vb){p.isThreadID(vb);qa(this,vb,function(yb){ub(this,'/ajax/mercury/unmark_spam.php',{id:yb});}.bind(this));var wb={action_type:n.CHANGE_FOLDER,action_id:null,thread_id:vb,new_folder:fa.INBOX},xb={actions:[wb],from_client:true,payload_source:w.CLIENT_CHANGE_FOLDER};this.handleUpdate(xb);},deleteThread:function(vb){p.isThreadID(vb);qa(this,vb,function(yb){var zb={ids:[yb]};ub(this,'/ajax/mercury/delete_thread.php',zb);}.bind(this));var wb={action_type:n.DELETE_THREAD,action_id:null,thread_id:vb},xb={actions:[wb],from_client:true,payload_source:w.CLIENT_DELETE_THREAD};this.handleUpdate(xb);},deleteMessages:function(vb,wb,xb){ca.getServerIDs(wb||[],function(zb){ub(this,'/ajax/mercury/delete_messages.php',{message_ids:zb});}.bind(this));var yb;if(xb){yb={action_type:n.DELETE_THREAD,action_id:null,thread_id:vb};}else yb={action_type:n.DELETE_MESSAGES,action_id:null,thread_id:vb,message_ids:wb};this.handleUpdate({actions:[yb],from_client:true,payload_source:w.CLIENT_DELETE_MESSAGES});},clearChat:function(vb,wb,xb){p.isThreadID(vb);ub(this,'/ajax/chat/settings.php',{clear_history_id:wb});var yb=[{action_type:n.CLEAR_CHAT,action_id:null,thread_id:vb,clear_time:xb}];this.handleUpdate({actions:yb,from_client:true,payload_source:w.CLIENT_CLEAR_CHAT});},sendNewMessage:function(vb,wb){wb=wb||ma;if(!vb.client_state||vb.client_state==v.SEND_TO_SERVER)ca.getServerIDs(vb.forward_message_ids||[],function(yb){var zb=vb.thread_id,ac=this.tokenizeThreadID(vb.thread_id),bc=ac.type,cc=ia({},vb);cc.forward_message_ids=yb;if((bc=='root'&&ac.value==cc.message_id)||(bc=='user'&&!ra(this,zb))||(vb.thread_id==r.PENDING_THREAD_ID)){cc.client_thread_id=cc.thread_id;cc.thread_id=null;this._sendNewMessageToServer(cc,wb);}else qa(this,cc.thread_id,function(dc){cc.thread_id=dc;this._sendNewMessageToServer(cc);}.bind(this));}.bind(this));if(vb.thread_id!=r.PENDING_THREAD_ID){var xb={actions:[ia({},vb)],from_client:true,payload_source:w.CLIENT_SEND_MESSAGE};this.handleUpdate(xb);}},_sendNewMessageToServer:function(vb,wb){wb=wb||ma;ub(this,'/ajax/mercury/send_messages.php',{message_batch:[vb],client:wb});},requestMessageConfirmation:function(vb,wb){wb=wb||ma;var xb={},yb={};for(var zb in vb){var ac=ra(this,zb);if(ac){xb[ac]=vb[zb];}else{var bc=vb[zb];for(var cc=0;cc<bc.length;cc++)yb[bc[cc]]=zb;}}var dc=Object.keys(xb),ec=Object.keys(yb);if(dc.length||ec.length)ub(this,'/ajax/mercury/confirm_messages.php',{thread_message_map:xb,local_messages:yb,client:wb});},handleMessageConfirmError:function(vb){var wb=vb.getRequest().getData().thread_message_map,xb=vb.getRequest().getData().local_messages;if(!wb&&!xb)return;var yb=[];for(var zb in wb){var ac=wb[zb];ac.forEach(function(dc){yb.push({action_type:n.SEND_MESSAGE,client_message_id:dc,message_id:dc,client_thread_id:null,thread_id:zb,status:m.UNABLE_TO_CONFIRM});});}for(var bc in xb){var cc=xb[bc];yb.push({action_type:n.SEND_MESSAGE,client_message_id:bc,message_id:bc,client_thread_id:cc,thread_id:null,status:m.UNABLE_TO_CONFIRM});}if(yb.length)this.handleUpdate({actions:yb,payload_source:w.CLIENT_HANDLE_ERROR});},markSeen:function(){var vb=i.convertActionIDToTimestamp(this._lastActionId);ub(this,'/ajax/mercury/mark_seen.php',{seen_timestamp:vb});},handleRoger:function(vb){var wb=vb.tid?this._serverToClientIDs.getResource(vb.tid):('user:'+vb.reader);if(wb){var xb={};xb[wb]={};xb[wb]['fbid:'+vb.reader]=vb.time;this.inform('update-roger',xb);}},handleUpdateWaitForThread:function(vb,wb,xb){xb=xb||ma;var yb=this._serverToClientIDs.getResource(wb);if(yb){this.handleUpdate(vb);return;}this._serverToClientIDs.executeOrEnqueue(wb,function(){this._pendingUpdates.push(vb);}.bind(this));if(!this._fetchingThreads[wb]){this._fetchingThreads[wb]=true;ub(this,'/ajax/mercury/thread_info.php',{threads:{thread_ids:[wb]},client:xb});}},handleUpdate:function(vb){var wb=[];if(vb&&vb.threads)for(var xb=0;xb<vb.threads.length;xb++){if(!vb.threads[xb].snippet_attachments)continue;for(var yb=0;yb<vb.threads[xb].snippet_attachments.length;yb++)if(vb.threads[xb].snippet_attachments[yb].share_xhp){wb.push({i:xb,j:yb,xhp:vb.threads[xb].snippet_attachments[yb].share_xhp});vb.threads[xb].snippet_attachments[yb].share_xhp="HTMLDivElement not shown: object contains circular "+"reference, which was breaking JSON.stringify. "+"Look at MercuryServerRequests.handleUpdate";}}la.debug('handle_update',{payload:vb,from_client:vb.from_client});for(var zb=0;zb<wb.length;zb++)vb.threads[wb[zb].i].snippet_attachments[wb[zb].j].share_xhp=wb[zb].xhp;for(zb in vb){ha.getForFBID(this._fbid).synchronizeInforms(function(){if(!vb.from_client){ya(this,vb);this.inform('payload-preprocessed',vb);}this.inform('update-thread-ids',this._newlyAddedClientIDs);this._newlyAddedClientIDs={};this.inform('update-participants',vb);this.inform('update-threads',vb);this.inform('update-unread',vb);this.inform('update-threadlist',vb);this.inform('update-messages',vb);this.inform('update-unseen',vb);this.inform('update-typing-state',vb);this.inform('update-roger',vb.roger);this.inform('model-update-completed',null);za(this);}.bind(this));break;}},_handleSendMessageErrorCommon:function(vb,wb,xb,yb){la.debug('handle_send_message_error_common',{reliability_error_status:xb,request_error_status:wb});var zb=vb.getData(),ac=zb.message_batch,bc=ac.map(function(dc){return {action_type:n.SEND_MESSAGE,client_message_id:dc.message_id,message_id:dc.message_id,client_thread_id:dc.client_thread_id,thread_id:dc.thread_id,status:wb,error_data:yb};});bc.forEach(function(dc){va(this,dc,xb);}.bind(this));var cc={actions:bc,payload_source:w.CLIENT_HANDLE_ERROR};this.handleUpdate(cc);},handleSendMessageError:function(vb){var wb=vb.getPayload(),xb=null,yb=null;if(wb&&wb.error_payload){xb=m.UNCONFIRMED;yb='send_error';}else{xb=m.ERROR;yb='request_error'+wa(vb);}var zb=vb.error;if(zb===1404102)h.verboseErrorHandler(vb);var ac=/<.*>/.test(vb.getErrorDescription())?vb.getErrorSummary():vb.getErrorDescription();this._handleSendMessageErrorCommon(vb.getRequest(),xb,yb,{type:q.SERVER,code:vb.getError(),description:ac,is_transient:vb.isTransient()});},handleSendMessageTransportError:function(vb){this._handleSendMessageErrorCommon(vb.getRequest(),m.ERROR,'transport_error'+wa(vb),{type:q.TRANSPORT,code:vb.getError(),is_transient:true});},handleSendMessageTimeout:function(vb){this._handleSendMessageErrorCommon(vb,m.ERROR,'transport_timeout',{type:q.TIMEOUT,is_transient:true});},getLastActionID:function(){return this._lastActionId;}});ia(hb,z);function ib(vb){return {action_type:n.LOG_MESSAGE,thread_id:vb,message_id:vb,timestamp:Date.now(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:aa.UNKNOWN,log_message_type:u.SERVER_ERROR,log_message_data:{}};}function jb(vb){var wb=vb.getData(),xb=wb.request_user_id?wb.request_user_id:j.getID();return hb.getForFBID(xb);}function kb(vb,wb){jb(wb).handleUpdate(vb);}function lb(vb,wb){var xb=vb.client||wb.client;return {client:xb,message_batch:vb.message_batch.concat(wb.message_batch)};}function mb(vb,wb){var xb={};ia(xb,vb.ids);ia(xb,wb.ids);var yb=vb.client||wb.client;return {ids:xb,client:yb};}function nb(vb,wb){return wb;}function ob(vb){var wb=jb(vb.getRequest());wb.handleThreadInfoError(vb);}function pb(vb){var wb=jb(vb.getRequest());wb.handleSendMessageError(vb);}function qb(vb){var wb=jb(vb.getRequest());wb.handleSendMessageTransportError(vb);}function rb(vb){var wb=jb(vb);wb.handleSendMessageTimeout(vb);}function sb(vb){var wb=jb(vb.getRequest());wb.handleMessageConfirmError(vb);}function tb(vb){ga.registerEndpoints({'/ajax/mercury/thread_sync.php':{request_user_id:vb._fbid,mode:ga.IDEMPOTENT,handler:kb},'/ajax/mercury/thread_info.php':{request_user_id:vb._fbid,mode:ga.BATCH_DEFERRED_MULTI,batch_function:ab,handler:kb,error_handler:ob},'/ajax/mercury/mark_folder_as_read.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb},'/ajax/mercury/change_read_status.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:mb,handler:kb},'/ajax/mercury/send_messages.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:lb,batch_size_limit:da.SEND_BATCH_LIMIT,handler:kb,error_handler:pb,transport_error_handler:qb,timeout:y.sendMessageTimeout,timeout_handler:rb,connection_retries:da.SEND_CONNECTION_RETRIES},'/ajax/mercury/mark_seen.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:nb,handler:kb},'/ajax/mercury/confirm_messages.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb,error_handler:sb},'/ajax/mercury/threadlist_info.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE_UNIQUE,batch_function:cb,handler:kb},'/ajax/mercury/mark_spam.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb},'/ajax/mercury/mark_spam_messages.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb},'/ajax/mercury/unmark_spam.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb},'/ajax/mercury/unread_threads.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE_UNIQUE,batch_function:bb,handler:kb},'/ajax/chat/settings.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:eb,handler:kb},'/ajax/mercury/delete_thread.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:gb,handler:kb},'/ajax/mercury/delete_messages.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb},'/ajax/mercury/move_thread.php':{request_user_id:vb._fbid,mode:ga.BATCH_SUCCESSIVE,batch_function:fb,handler:kb},'/ajax/mercury/change_mute_thread.php':{request_user_id:vb._fbid,mode:ga.IMMEDIATE,handler:kb}});}function ub(vb,wb,xb,yb){ga.trySend(wb,xb,yb,vb._fbid);}e.exports=hb;});
__d("MercuryAttachment",["MercuryAttachmentContentType","MercuryAttachmentType","startsWith"],function(a,b,c,d,e,f){var g=b('MercuryAttachmentContentType'),h=b('MercuryAttachmentType'),i=b('startsWith'),j={getAttachIconClass:function(k){switch(k){case g.PHOTO:return 'MercuryPhotoIcon';case g.VIDEO:return 'MercuryVideoIcon';case g.MUSIC:return 'MercuryMusicIcon';case g.VOICE:return 'MercuryVoiceIcon';case g.TEXT:return 'MercuryTextIcon';case g.MSWORD:return 'MercuryMSWordIcon';case g.MSXLS:return 'MercuryMSXLSIcon';case g.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(k){if(i(k,'image')){return 'MercuryPhotoIcon';}else if(i(k,'video')){return 'MercuryVideoIcon';}else if(i(k,'audio')){return 'MercuryMusicIcon';}else if(i(k,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(k){if(i(k,'image')){return g.PHOTO;}else if(i(k,'video')){return g.VIDEO;}else if(i(k,'audio')){return g.MUSIC;}else if(i(k,'text/plain')){return g.TEXT;}else return g.UNKNOWN;},convertRaw:function(k){var l=[];for(var m=0;m<k.length;m++){var n=k[m];if(n.attach_type===h.PHOTO){l.push(n);}else if(n.filename){var o=j.getAttachTypeByMime(n.filetype),p={};p.attach_type=h.FILE;p.name=n.filename;p.icon_type=o;p.url='';if(o==g.PHOTO)p.preview_loading=true;l.push(p);}}return l;},get:function(k){if(k.attachments){return k.attachments;}else if(k.raw_attachments){return this.convertRaw(k.raw_attachments);}else return [];}};e.exports=j;});
__d("ImageSourceType",[],function(a,b,c,d,e,f){var g={PROFILE_PICTURE:'profile_picture',IMAGE:'image'};e.exports=g;});
__d("ImageSourceRequest",["CurrentUser","ImageSourceType","KeyedCallbackManager","PhotoResizeModeConst","MercuryServerDispatcher","arrayContains","extendArray"],function(a,b,c,d,e,f){var g=b('CurrentUser'),h=b('ImageSourceType'),i=b('KeyedCallbackManager'),j=b('PhotoResizeModeConst'),k=b('MercuryServerDispatcher'),l=b('arrayContains'),m=b('extendArray');function n(){"use strict";this._request={fbid:null,type:null,width:null,height:null,resize_mode:null};this._callback=null;}n.prototype.setFBID=function(r){"use strict";this._request.fbid=r;return this;};n.prototype.setType=function(r){"use strict";if(!l([h.PROFILE_PICTURE,h.IMAGE],r))throw new TypeError('ImageSourceRequest.setType: invalid type '+r);this._request.type=r;return this;};n.prototype.setDimensions=function(r,s){"use strict";this._request.width=r;this._request.height=s;return this;};n.prototype.setResizeMode=function(r){"use strict";if(!l([j.COVER,j.CONTAIN],r))throw new TypeError('ImageSourceRequest.setResizeMode: invalid resize mode '+r);this._request.resize_mode=r;return this;};n.prototype.setCallback=function(r){"use strict";this._callback=r;return this;};n.prototype.send=function(){"use strict";if(!this._request.fbid||!this._request.width||!this._request.height||!this._request.type||!this._request.resize_mode||!this._callback)throw new Error('ImageSourceRequest: You must set all the fields');var r=p(),s=q(this._request);r.executeOrEnqueue(s,this._callback);if(r.getUnavailableResourcesFromRequest(s).length===1){k.trySend('/ajax/image_source.php',{requests:[this._request]});return true;}return false;};var o=null;function p(){if(o)return o;var r=new i();o=r;k.registerEndpoints({'/ajax/image_source.php':{request_user_id:g.getID(),mode:k.BATCH_DEFERRED_MULTI,batch_function:function(s,t){m(s.requests,t.requests);return s;},handler:function(s,t){var u=t.getData().requests;for(var v=0;v<u.length;++v)r.setResource(q(u[v]),s[v]);}}});return r;}function q(r){return [r.fbid,r.type,r.width,r.height,r.resize_mode].join('|');}e.exports=n;});
__d("MercuryParticipants",["CurrentUser","ImageSourceRequest","ImageSourceType","MercuryAssert","MercuryIDs","MercuryParticipantsConstants","MercuryParticipantTypes","PhotoResizeModeConst","ShortProfiles","copyProperties","getObjectValues","tx","MercuryServerRequests"],function(a,b,c,d,e,f){var g=b('CurrentUser'),h=b('ImageSourceRequest'),i=b('ImageSourceType'),j=b('MercuryAssert'),k=b('MercuryIDs'),l=b('MercuryParticipantsConstants'),m=b('MercuryParticipantTypes'),n=b('PhotoResizeModeConst'),o=b('ShortProfiles'),p=b('copyProperties'),q=b('getObjectValues'),r=b('tx'),s=b('MercuryServerRequests').get(),t='fbid:'+g.getID(),u={},v={},w=function(ba){ba=z(ba);if(u[ba.id]){p(u[ba.id],ba);}else u[ba.id]=p({},ba);if(ba.vanity)v[ba.vanity]=ba.id;};function x(ba){j.isEmailParticipantID(ba);var ca=k.tokenize(ba),da=ca.value;return {gender:l.UNKNOWN_GENDER,href:null,id:ba,image_src:l.EMAIL_IMAGE,big_image_src:l.EMAIL_IMAGE,name:da,short_name:da,employee:false,call_promo:false};}function y(ba,ca,da){j.allParticipantIDs(ba);var ea={},fa={};ba.forEach(function(ha){if(u[ha]&&!da){ea[ha]=p({},u[ha]);}else{var ia=k.tokenize(ha);if(ia.type=='fbid'){var ja=ia.value;fa[ha]=ja;}else if(ia.type=='email')ea[ha]=x(ha);}});var ga=q(fa);if(ga.length){o.getMulti(ga,function(ha){for(var ia in fa){var ja=fa[ia],ka=ha[ja];ea[ia]={gender:ka.gender,href:ka.uri,id:ia,image_src:ka.thumbSrc,name:ka.name,short_name:ka.firstName,employee:ka.employee,call_promo:ka.showVideoPromo,type:ka.type,vanity:ka.vanity,is_friend:ka.is_friend,social_snippets:ka.social_snippets};w(ea[ia]);}ca(ea);});}else ca(ea);}function z(ba){var ca=ba.type===m.USER||ba.type===m.FRIEND;if(!ca)return ba;if(!ba.name&&!ba.href&&!ba.vanity){var da="Facebook User";ba.name=da;ba.short_name=da;}return ba;}var aa={user:t,isAuthor:function(ba){return ba===t;},getIDFromVanityOrFBID:function(ba){if(!ba)return;if(v[ba])return v[ba];if(ba.match('^\\d+$'))return aa.getIDForUser(ba);},getNow:function(ba){return u[ba];},get:function(ba,ca){j.isParticipantID(ba);aa.getMulti([ba],function(da){ca(da[ba]);});},getMulti:function(ba,ca,da){return y(ba,ca,false);},getMap:function(ba,ca){var da=[];for(var ea in ba)if(Array.isArray(ba[ea])){da=da.concat(ba[ea]);}else if(ba[ea])da.push(ba[ea]);this.getMulti(da,function(fa){var ga={};for(var ha in ba)if(Array.isArray(ba[ha])){ga[ha]=ba[ha].map(function(ia){return fa[ia];});}else ga[ha]=fa[ba[ha]];ca(ga);});},getBigImageMulti:function(ba,ca){j.allParticipantIDs(ba);var da=l.BIG_IMAGE_SIZE;aa.getMulti(ba,function(ea){var fa={},ga=0,ha=function(la,ma){ga++;fa[la]=ma;if(ga===ba.length)ca(fa);},ia=function(la,ma){u[la].big_image_src=ma.uri;ha(la,ma.uri);};for(var ja in ea){var ka=ea[ja];if(!ka.big_image_src){new h().setFBID(aa.getUserID(ja)).setType(i.PROFILE_PICTURE).setDimensions(da,da).setResizeMode(n.COVER).setCallback(ia.bind(null,ja)).send();}else ha(ka.id,ka.big_image_src);}});},getOrderedBigImageMulti:function(ba,ca){aa.getBigImageMulti(ba,function(da){var ea=ba.map(function(fa){return da[fa];});ca(ea);});},getMultiForceDownload:function(ba,ca){return y(ba,ca,true);},getUserID:function(ba){return k.getUserIDFromParticipantID(ba);},getIDForUser:function(ba){return 'fbid:'+ba;},addParticipants:function(ba){ba.forEach(w);}};s.subscribe('update-participants',function(ba,ca){aa.addParticipants(ca.participants||[]);});e.exports=aa;});
__d("MercuryThreads",["TimestampConverter","MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryAssert","MercuryAttachment","MercuryGlobalActionType","MercuryIDs","MercuryLogMessageType","MercurySingletonMixin","MercuryThreadMode","MessagingTag","MercuryParticipants","ReportState","MercuryServerRequests","MercuryThreadInformer","copyProperties","createObjectFrom","removeFromArray"],function(a,b,c,d,e,f){var g=b('TimestampConverter'),h=b('MercuryFolders'),i=b('LogHistory'),j=b('KeyedCallbackManager'),k=b('MercuryActionTypeConstants'),l=b('MercuryAssert'),m=b('MercuryAttachment'),n=b('MercuryGlobalActionType'),o=b('MercuryIDs'),p=b('MercuryLogMessageType'),q=b('MercurySingletonMixin'),r=b('MercuryThreadMode'),s=b('MessagingTag'),t=b('MercuryParticipants'),u=b('ReportState'),v=b('MercuryServerRequests'),w=b('MercuryThreadInformer'),x=b('copyProperties'),y=b('createObjectFrom'),z=b('removeFromArray'),aa=i.getInstance('mercury_threads');function ba(na,oa,pa){var qa=y(oa.participants,true),ra=t.getIDForUser(na._fbid);pa.forEach(function(sa){if(qa[sa]!==true){oa.participants.push(sa);if(sa===ra)oa.is_subscribed=true;}});}function ca(na,oa,pa){z(oa.participants,pa);if(pa===t.getIDForUser(na._fbid))oa.is_subscribed=false;}function da(na,oa){if(na.participants[0]!=oa){z(na.participants,oa);na.participants.unshift(oa);}}function ea(na,oa){var pa=oa.body,qa=oa.subject,ra='';if(qa){qa=qa.toLowerCase();if(pa.slice(0,qa.length).toLowerCase()==qa){ra=pa;}else if(pa){ra=qa+' \u00B7 '+pa;}else ra=qa;}else ra=pa;na.snippet=ra;na.snippet_has_attachment=oa.has_attachment;if(oa.raw_attachments&&oa.raw_attachments.length>0){var sa=m.convertRaw(oa.raw_attachments);na.snippet_attachments=sa;}else na.snippet_attachments=oa.attachments;na.is_forwarded_snippet=!!oa.forward_count;na.snippet_sender=oa.author;}function fa(na,oa,pa){if(!oa)return false;if(!oa.timestamp)return true;var qa=!oa.unread_count;if(pa==qa)return false;oa.unread_count=pa?0:1;na._threadInformer.updatedThread(oa.thread_id);return true;}function ga(na,oa){var pa=na._threads.getAllResources();for(var qa in pa){var ra=pa[qa];if(ra.folder==oa){ra.unread_count=0;na._threads.setResource(qa,ra);na._threadInformer.updatedThread(qa);}}}function ha(na,oa,pa){if(!oa||oa.chat_clear_time===pa)return false;oa.chat_clear_time=pa;na._threadInformer.reorderedMessages(oa.thread_id);return true;}function ia(na,oa,pa,qa){var ra=pa.action_type;if(ra==k.USER_GENERATED_MESSAGE||ra==k.LOG_MESSAGE){pa.is_unread&&oa.unread_count++;oa.message_count++;oa.is_archived=false;}switch(ra){case k.USER_GENERATED_MESSAGE:da(oa,pa.author);break;case k.SEND_MESSAGE:var sa=pa.log_message_type;if(sa==p.THREAD_IMAGE)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;oa.snippet_attachments=pa.attachments;break;case k.LOG_MESSAGE:var sa=pa.log_message_type;if(sa==p.SUBSCRIBE){ba(na,oa,pa.log_message_data.added_participants);}else if(sa==p.JOINABLE_JOINED){ba(na,oa,[pa.log_message_data.joined_participant]);}else if(sa==p.UNSUBSCRIBE){ca(na,oa,pa.author);}else if(sa==p.THREAD_IMAGE){if(!qa)oa.image_src=pa.log_message_data.image?pa.log_message_data.image.preview_url:null;}else if(sa==p.THREAD_NAME)oa.name=pa.log_message_data.name;break;case k.CHANGE_READ_STATUS:if(pa.timestamp)na._threadInformer.changedThreadReadState(oa.thread_id,pa.mark_as_read,pa.timestamp);fa(na,oa,pa.mark_as_read);break;case k.CLEAR_CHAT:ha(na,oa,pa.clear_time);break;case k.CHANGE_ARCHIVED_STATUS:oa.is_archived=pa.archived;break;case k.CHANGE_FOLDER:oa.folder=pa.new_folder;break;case k.DELETE_MESSAGES:if(qa){oa.snippet='...';oa.snippet_has_attachment=false;oa.snippet_attachments=null;oa.snippet_sender=null;oa.is_forwarded_snippet=false;na._threadInformer.updatedThread(pa.thread_id);}else if(pa.message_ids)oa.message_count=oa.message_count-pa.message_ids.length;break;case k.CHANGE_MUTE_SETTINGS:if(pa.mute_settings!==undefined){var ta=na._fbid+'@facebook.com';if(oa.mute_settings){if(pa.mute_settings){oa.mute_settings[ta]=pa.mute_settings;}else delete oa.mute_settings[ta];na._threadInformer.updatedThread(oa.thread_id);}}break;}if(pa.action_id)oa.last_action_id=g.maxValidActionID(pa.action_id,oa.last_action_id);}function ja(na,oa){var pa=na._serverRequests.tokenizeThreadID(oa.thread_id);if(pa.type=='group'){aa.error('invalid_new_thread_message',oa);return undefined;}var qa=la(na,oa.specific_to_list),ra={thread_id:oa.thread_id,last_action_id:oa.action_id,participants:oa.specific_to_list,name:null,snippet:oa.body,snippet_has_attachment:false,snippet_attachments:[],snippet_sender:oa.author,unread_count:0,message_count:0,image_src:null,timestamp_absolute:oa.timestamp_absolute,timestamp_relative:oa.timestamp_relative,timestamp:oa.timestamp,canonical_fbid:pa.type==='user'?pa.value:null,is_canonical_user:pa.type==='user',is_canonical:qa,is_subscribed:true,root_message_threading_id:oa.message_id,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};return ra;}function ka(na){this._fbid=na;this._serverRequests=v.getForFBID(this._fbid);this._threadInformer=w.getForFBID(this._fbid);this._threads=new j();ma(this);}x(ka.prototype,{getThreadMetaNow:function(na){l.isThreadID(na);return this._threads.getResource(na);},getThreadMeta:function(na,oa,pa){var qa=function(ra){oa(ra[na]);};return this.getMultiThreadMeta([na],qa,pa);},getMultiThreadMeta:function(na,oa,pa){l.allThreadID(na);var qa=this._threads.executeOrEnqueue(na,oa),ra=this._threads.getUnavailableResources(qa);if(ra.length){var sa=[];for(var ta=0;ta<ra.length;ta++){var ua=ra[ta],va=this._serverRequests.tokenizeThreadID(ua);if(va.type=='user'){var wa=this.getCanonicalThreadToUser(va.value,null,pa,true);if(this.isEmptyLocalThread(wa.thread_id))sa.push(wa.thread_id);}else sa.push(ua);}if(sa.length)this._serverRequests.fetchThreadData(sa,pa);}return qa;},unsubscribe:function(na){this._threads.unsubscribe(na);},changeThreadReadStatus:function(na,oa){l.isThreadID(na);var pa=this._threads.getResource(na);if(fa(this,pa,oa))this._serverRequests.changeThreadReadStatus(na,oa,h.getFromMeta(pa));},changeThreadArchivedStatus:function(na,oa){l.isThreadID(na);var pa=this._threads.getResource(na);if(pa.is_archived!=oa){pa.is_archived=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadArchivedStatus(na,oa);}},markThreadSpam:function(na){this._serverRequests.markThreadSpam(na);},unmarkThreadSpam:function(na){this._serverRequests.unmarkThreadSpam(na);},updateThreadMuteSetting:function(na,oa){this._serverRequests.changeMutingOnThread(na,oa);},changeFolder:function(na,oa){l.isThreadID(na);var pa=this._threads.getResource(na);if(pa&&pa.folder!=oa){pa.folder=oa;this._threadInformer.updatedThread(pa.thread_id);this._serverRequests.changeThreadFolder(na,oa);}},deleteThread:function(na){l.isThreadID(na);this._serverRequests.deleteThread(na);},updateThreads:function(na){if(!na||!na.length)return;var oa={};na.forEach(function(pa){oa[pa.thread_id]=pa;});this._threads.addResourcesAndExecute(oa);},updateMetadataByActions:function(na,oa){if(!na||!na.length)return;var pa={},qa={},ra={};for(var sa=0;sa<na.length;sa++){var ta=na[sa];if(ta.is_forward)continue;var ua=ta.action_type,va=ta.thread_id;l.isThreadID(va);var wa=this.getThreadMetaNow(va);if(ua==k.LOG_MESSAGE&&ta.log_message_type==p.SERVER_ERROR)continue;if(!wa&&!ta.action_id&&ua==k.USER_GENERATED_MESSAGE){wa=ja(this,ta);this._threads.setResource(va,wa);}if(wa){if(ua==k.DELETE_THREAD){wa.message_count=0;this._threadInformer.deletedThread(va);continue;}var xa=!!ta.action_id;if(ua==k.LOG_MESSAGE||ua==k.USER_GENERATED_MESSAGE)xa=!oa;if(wa.server_timestamp&&ta.timestamp<=wa.server_timestamp&&xa)continue;if(!ra[va])ra[va]=x({},wa);ia(this,ra[va],ta,oa);if(ua==k.USER_GENERATED_MESSAGE)pa[va]=ta;if(ua==k.USER_GENERATED_MESSAGE||ua==k.LOG_MESSAGE||ua==k.SEND_MESSAGE)if(ta&&ta.timestamp&&(!qa[va]||ta.timestamp>qa[va].timestamp))qa[va]=ta;}}for(var ya in ra){var za=ra[ya],ab=pa[ya];if(ab)ea(za,ab);var bb=qa[ya],cb=za.timestamp;if(bb){if(bb.timestamp>cb)za=x(za,{timestamp_absolute:bb.timestamp_absolute,timestamp_relative:bb.timestamp_relative,timestamp:bb.timestamp});var db=za.server_timestamp;if(!oa&&bb.timestamp>db)za.server_timestamp=bb.timestamp;}this._threads.setResource(ya,za);}},getCanonicalThreadToUser:function(na,oa,pa,qa){return this.getCanonicalThreadToParticipant('fbid:'+na,oa,pa,qa);},getCanonicalThreadToParticipant:function(na,oa,pa,qa){var ra=this.getThreadIDForParticipant(na),sa=this._threads.getResource(ra);if(typeof sa=='undefined'){sa=this.createNewLocalThread(ra,[t.getIDForUser(this._fbid),na],oa);!qa&&this._serverRequests.fetchThreadData([ra],pa);}return sa;},getThreadIdForUser:function(na){return 'user:'+na;},getThreadIDForParticipant:function(na){var oa=o.tokenize(na);return this.getThreadIdForUser(oa.value);},createNewLocalThread:function(na,oa,pa){var qa=this._threads.getResource(na);if(!qa){var ra=this._serverRequests.tokenizeThreadID(na);qa={thread_id:na,last_action_id:null,participants:oa,name:null,snippet:'',snippet_has_attachment:false,snippet_sender:null,unread_count:pa?pa:0,message_count:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,canonical_fbid:ra.type==='user'?ra.value:null,is_canonical_user:ra.type=='user',is_canonical:la(this,oa),is_subscribed:true,root_message_threading_id:null,folder:s.INBOX,is_archived:false,mode:r.TITAN_ORIGINATED};this._threads.setResource(na,qa);}return qa;},addParticipantsToThreadLocally:function(na,oa){var pa=this._threads.getResource(na);if(pa){ba(this,pa,oa);this._threadInformer.updatedThread(pa.thread_id);}},getCanonicalUserInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='user'?oa.value:null;},getCanonicalGroupInThread:function(na){var oa=this._serverRequests.tokenizeThreadID(na);return oa.type=='group'?oa.value:null;},isEmptyLocalThread:function(na){var oa=this._threads.getResource(na);if(!oa)return false;var pa=this._serverRequests.tokenizeThreadID(na);return pa.type=='root'&&!oa.timestamp;},isNewEmptyLocalThread:function(na){if(!this.isEmptyLocalThread(na))return false;var oa=this._threads.getResource(na);return oa.participants&&oa.participants.length===0;},canReply:function(na){var oa=this._threads.getResource(na);return oa&&oa.is_subscribed&&oa.mode!=r.OBJECT_ORIGINATED&&(oa.recipients_loadable||oa.recipients_loadable===undefined);}});x(ka,q);function la(na,oa){var pa=oa.filter(function(qa){return qa!=t.getIDForUser(na._fbid);});return pa.length<=1;}function ma(na){na._serverRequests.subscribe('update-threads',function(oa,pa){var qa=(pa.actions||[]).filter(function(ua){return ua.thread_id;});na.updateThreads(pa.threads);na.updateMetadataByActions(qa,pa.from_client);(pa.threads||[]).forEach(function(ua){na._threadInformer.updatedThread(ua.thread_id);});var ra=pa.global_actions||[];for(var sa=0;sa<ra.length;sa++){var ta=ra[sa];if(ta.action_type==n.MARK_ALL_READ)ga(na,ta.folder);}});}u.registerCallback('mercury-threads',function(){var na={};na.threads={};var oa=ka._getInstances();for(var pa in oa)na.threads[pa]=oa[pa]._threads.dumpResources();return na;});e.exports=ka;});
__d("MercuryOrderedThreadlist",["LogHistory","MercuryActionTypeConstants","MercuryFilters","MercuryFolders","MercuryPayloadSource","MercurySingletonMixin","MessagingTag","RangedCallbackManager","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties"],function(a,b,c,d,e,f){var g=b('LogHistory'),h=b('MercuryActionTypeConstants'),i=b('MercuryFilters'),j=b('MercuryFolders'),k=b('MercuryPayloadSource'),l=b('MercurySingletonMixin'),m=b('MessagingTag'),n=b('RangedCallbackManager'),o=b('MercuryServerRequests'),p=b('MercuryThreadInformer'),q=b('MercuryThreads'),r=b('arrayContains'),s=b('copyProperties'),t=g.getInstance('ordered_threadlist_model'),u=i.getSupportedFilters().concat([i.ALL,m.GROUPS]),v=j.getSupportedFolders();function w(ga,ha,ia,ja){var ka=[],la=false,ma=false,na=(ha||[]).filter(function(ua){var va=ua.filter||i.ALL;return (ua.folder==ia||(!ua.folder&&ia==m.INBOX))&&va==ja;}),oa=ga._threadlistOrderMap[ia][ja].getAllResources(),pa;na.forEach(function(ua){ka=ka.concat(ua.thread_ids);if(ua.error){if(ua.end>oa.length)ma=ua.error;}else{var va=ua.end-ua.start;if(ua.thread_ids.length<va)la=true;}if(!pa||ua.end>pa)pa=ua.end;});aa(ga,ka,ia,ja);if(la){ga._threadlistOrderMap[ia][ja].setReachedEndOfArray();}else if(ma){ga._threadlistOrderMap[ia][ja].setError(ma);}else{var qa=ga._threadlistOrderMap[ia][ja].getCurrentArraySize();if(pa&&qa<pa){var ra={},sa=oa.concat(ka),ta=sa.filter(function(ua){var va=ra[ua];ra[ua]=true;return va;});if(ta.length){t.warn('duplicate_threads',{folder:ia,expected_final_size:pa,actual_final_size:qa,duplicate_thread_ids:ta});ga._serverRequests.fetchThreadlistInfo(pa,ta.length,ia,ja==i.ALL?null:ja);}}}}function x(ga,ha){v.forEach(function(ia){u.forEach(function(ja){w(ga,ha,ia,ja);});});}function y(ga,ha){var ia={};v.forEach(function(ja){ia[ja]={};u.forEach(function(ka){ia[ja][ka]={to_add:[],to_remove:[],to_remove_if_last_after_add:{}};});});ha.forEach(function(ja){if(ja.is_forward)return;var ka=ja.thread_id,la=ba(ga,ka),ma=ca(ga,ka);function na(){ma.forEach(function(pa){ia[la][pa].to_add.push(ka);if(!ga._threadlistOrderMap[la][pa].hasReachedEndOfArray()&&!ga._threadlistOrderMap[la][pa].hasResource(ka))ia[la][pa].to_remove_if_last_after_add[ka]=true;});}function oa(pa){if(r(u,pa))if(r(ma,pa)){ia[la][pa].to_add.push(ka);}else ia[la][pa].to_remove.push(ka);}if(!la){if(ja.action_type===h.CHANGE_FOLDER||ja.action_type===h.CHANGE_ARCHIVED_STATUS)v.forEach(function(pa){if(pa!==la)u.forEach(function(qa){ga._threadlistOrderMap[pa][qa].removeResources([ka]);});});return;}switch(ja.action_type){case h.DELETE_THREAD:ma.forEach(function(pa){ia[la][pa].to_remove.push(ka);});break;case h.CHANGE_ARCHIVED_STATUS:case h.CHANGE_FOLDER:na();break;case h.CHANGE_READ_STATUS:oa(m.UNREAD);break;case h.USER_GENERATED_MESSAGE:case h.LOG_MESSAGE:ma.forEach(function(pa){if(da(ga,ka,la,pa))ia[la][pa].to_add.push(ka);});break;}});v.forEach(function(ja){u.forEach(function(ka){var la=ga._threadlistOrderMap[ja][ka];aa(ga,ia[ja][ka].to_add,ja,ka);for(var ma=la.getCurrentArraySize()-1;ma>=0;ma--){var na=la.getResourceAtIndex(ma);if(!ia[ja][ka].to_remove_if_last_after_add[na])break;ia[ja][ka].to_remove.push(na);}la.removeResources(ia[ja][ka].to_remove);});});}function z(ga,ha){var ia={};v.forEach(function(ja){ia[ja]={};u.forEach(function(ka){ia[ja][ka]=[];});});ha.forEach(function(ja){var ka=ba(ga,ja.thread_id),la=ca(ga,ja.thread_id);if(ka)la.forEach(function(ma){if(da(ga,ja.thread_id,ka,ma))ia[ka][ma].push(ja.thread_id);});});v.forEach(function(ja){u.forEach(function(ka){if(ia[ja][ka].length>0)aa(ga,ia[ja][ka],ja,ka);});});}function aa(ga,ha,ia,ja){ja=ja||i.ALL;ga._threadlistOrderMap[ia][ja].addResources(ha);v.forEach(function(ka){if(ka!=ia)ga._threadlistOrderMap[ka][ja].removeResources(ha);});}function ba(ga,ha){var ia=ga._threads.getThreadMetaNow(ha),ja=null;if(!ia){ja='No thread metadata';}else if(!ia.folder)ja='No thread folder';if(ja){var ka={error:ja,tid:ha};t.warn('no_thread_folder',ka);return null;}var la=ia.folder;if(ia.is_archived)la=m.ACTION_ARCHIVED;if(ga._threadlistOrderMap[la]){return la;}else return null;}function ca(ga,ha){var ia=ga._threads.getThreadMetaNow(ha),ja=[i.ALL];if(!ia){var ka={error:'no_thread_metadata',tid:ha};t.warn('no_thread_metadata',ka);return [];}if(ia.unread_count)ja.push(m.UNREAD);if(!ia.is_canonical)ja.push(m.GROUPS);return ja;}function da(ga,ha,ia,ja){var ka=ga._threads.getThreadMetaNow(ha);return ka&&ka.timestamp&&ba(ga,ha)==ia&&r(ca(ga,ha),ja);}function ea(ga){this._fbid=ga;this._serverRequests=o.getForFBID(this._fbid);this._threadInformer=p.getForFBID(this._fbid);this._threads=q.getForFBID(this._fbid);this._threadlistOrderMap={};v.forEach(function(ha){this._threadlistOrderMap[ha]={};u.forEach(function(ia){this._threadlistOrderMap[ha][ia]=new n(function(ja){return this._threads.getThreadMetaNow(ja).timestamp;}.bind(this),function(ja,ka){return ka-ja;},this._serverRequests.canLinkExternally.bind(this._serverRequests));}.bind(this));}.bind(this));this._serverRequests.subscribe('update-threadlist',function(ha,ia){if(!fa(ia))return;var ja=ia.ordered_threadlists;if(ja&&ja.length){x(this,ja);}else{var ka=(ia.actions||[]).filter(function(la){return la.thread_id;});z(this,ia.threads||[]);y(this,ka);}this._threadInformer.updatedThreadlist();}.bind(this));}s(ea.prototype,{getThreadlist:function(ga,ha,ia,ja,ka,la){return this.getFilteredThreadlist(ga,ha,ia,i.ALL,ja,ka,la);},getFilteredThreadlist:function(ga,ha,ia,ja,ka,la,ma){var na=this._threadlistOrderMap[ia][ja],oa=na.executeOrEnqueue(ga,ha,ka,la),pa=na.getUnavailableResources(oa),qa=na.getError(ga,ha,la);if(pa.length||qa){if(na.getCurrentArraySize()<ga){var ra={start:ga,limit:ha,filter:ja,resources_size:na.getCurrentArraySize()};t.warn('range_with_gap',ra);}na.setError(false);this._serverRequests.fetchThreadlistInfo(na.getCurrentArraySize(),pa.length,ia,ja==i.ALL?null:ja,ma);}return oa;},getThreadlistUntilTimestamp:function(ga,ha,ia){ia=ia||i.ALL;return this._threadlistOrderMap[ha][ia].getElementsUntil(ga);},unsubscribe:function(ga,ha,ia){ia=ia||i.ALL;this._threadlistOrderMap[ha][ia].unsubscribe(ga);}});s(ea,l);function fa(ga){switch(ga.payload_source){case k.CLIENT_CHANGE_ARCHIVED_STATUS:case k.CLIENT_CHANGE_READ_STATUS:case k.CLIENT_CHANGE_FOLDER:case k.CLIENT_CHANNEL_MESSAGE:case k.CLIENT_DELETE_MESSAGES:case k.CLIENT_DELETE_THREAD:case k.CLIENT_SEND_MESSAGE:case k.SERVER_SEND_MESSAGE:case k.SERVER_CONFIRM_MESSAGES:case k.SERVER_FETCH_THREADLIST_INFO:case k.SERVER_THREAD_SYNC:return true;case k.SERVER_INITIAL_DATA:return ga.ordered_threadlists;default:return false;}}e.exports=ea;});
__d("MercuryUnreadState",["MercuryFolders","LogHistory","KeyedCallbackManager","MercuryActionTypeConstants","MercuryGlobalActionType","MercurySingletonMixin","MercuryThreadlistConstants","MessagingTag","ReportState","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","arrayContains","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('MercuryFolders'),h=b('LogHistory'),i=b('KeyedCallbackManager'),j=b('MercuryActionTypeConstants'),k=b('MercuryGlobalActionType'),l=b('MercurySingletonMixin'),m=b('MercuryThreadlistConstants'),n=b('MessagingTag'),o=b('ReportState'),p=b('MercuryServerRequests'),q=b('MercuryThreadInformer'),r=b('MercuryThreads'),s=b('arrayContains'),t=b('copyProperties'),u=b('createObjectFrom'),v=(g.getSupportedFolders()||[]).filter(function(ma){return ma!=n.ACTION_ARCHIVED;}),w='unread_thread_hash',x='unseen_thread_list',y=m.MAX_UNREAD_COUNT,z=h.getInstance('mercury_unread_state');function aa(ma){this._fbid=ma;this._serverRequests=p.getForFBID(this._fbid);this._threadInformer=q.getForFBID(this._fbid);this._threads=r.getForFBID(this._fbid);this._allReadTimestamp={};this._threadReadTimestamp={};this._initialUnreadCount={};this._maxCount={};this._unreadResources={};v.forEach(function(na){this._initialUnreadCount[na]=0;this._maxCount[na]=false;this._unreadResources[na]=new i();}.bind(this));this._serverRequests.subscribe('update-unread',function(na,oa){fa(this,oa);var pa=oa.global_actions||[];for(var qa=0;qa<pa.length;qa++){var ra=pa[qa];if(ra.action_type==k.MARK_ALL_READ)ia(this,ra.folder,ra.timestamp);}}.bind(this));this._serverRequests.subscribe('update-thread-ids',function(na,oa){ka(this,oa);}.bind(this));}t(aa.prototype,{getUnreadCount:function(ma){if(this.exceedsMaxCount(ma)){z.error('unguarded_unread_count_fetch',{});return 0;}return ea(this,ma);},exceedsMaxCount:function(ma){return this._maxCount[ma]||(ea(this,ma)>y);},markFolderAsRead:function(ma){if(this._maxCount[ma]||ea(this,ma)>0)this._serverRequests.markFolderAsRead(ma);}});t(aa,l);function ba(ma,na,oa){ma._unreadResources[na].setResource(w,oa);ma._unreadResources[na].setResource(x,Object.keys(oa));}function ca(ma,na,oa){var pa=ma._unreadResources[na].executeOrEnqueue(w,oa),qa=ma._unreadResources[na].getUnavailableResources(pa);if(qa.length)ma._serverRequests.fetchUnreadThreadIDs(na);}function da(ma,na){return ma._unreadResources[na].getResource(w);}function ea(ma,na){var oa=ma._unreadResources[na].getResource(x);if(oa){return oa.length;}else return ma._initialUnreadCount[na];}function fa(ma,na){var oa;(na.unread_thread_ids||[]).forEach(function(pa){oa=pa.folder;if(!la(oa))return;var qa=ja(ma,pa.thread_ids);ba(ma,oa,u(qa,true));if(qa.length>y)ma._maxCount[oa]=true;ma._threadInformer.updatedUnreadState();});(na.message_counts||[]).forEach(function(pa){if(pa.unread_count===undefined)return;oa=pa.folder;if(pa.unread_count>y){ma._maxCount[oa]=true;ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}else{ma._initialUnreadCount[oa]=pa.unread_count;if(ma._initialUnreadCount[oa]===0)ba(ma,oa,{});ma._threadInformer.updatedUnreadState();}});(na.actions||[]).forEach(function(pa){if(pa.is_forward)return;var qa=j,ra=pa.thread_id?pa.thread_id:pa.server_thread_id;if(pa.action_type==qa.DELETE_THREAD){v.forEach(function(ta){ha(ma,ta,ra);});}else if(pa.action_type==qa.CHANGE_ARCHIVED_STATUS||pa.action_type==qa.CHANGE_FOLDER){var sa=ma._threads.getThreadMetaNow(pa.thread_id);oa=g.getFromMeta(sa);if(la(oa)&&sa.unread_count>0)ga(ma,oa,ra);v.forEach(function(ta){if(ta!=oa)ha(ma,ta,ra);});}else{oa=pa.folder;if(!la(oa))return;if(pa.action_type==qa.CHANGE_READ_STATUS){if(pa.mark_as_read){ha(ma,oa,ra,pa.timestamp);}else ga(ma,oa,ra,pa.timestamp);}else if(pa.action_type==qa.USER_GENERATED_MESSAGE||pa.action_type==qa.LOG_MESSAGE)if(pa.is_unread)ga(ma,oa,ra,pa.timestamp);}});}function ga(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){var ra=ma._allReadTimestamp[na]||0,sa=ma._threadReadTimestamp[oa]||0,ta=pa||Number.POSITIVE_INFINITY;if(ta>=ra&&ta>=sa&&!qa[oa]){qa[oa]=pa||0;ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ha(ma,na,oa,pa){if(ma._maxCount[na])return;ca(ma,na,function(qa){if(pa){var ra=ma._threadReadTimestamp[oa];if(!ra||ra<pa)ma._threadReadTimestamp[oa]=pa;}var sa=qa[oa];if(pa&&typeof sa=='number'&&pa<sa)return;if(oa in qa){delete qa[oa];ba(ma,na,qa);ma._threadInformer.updatedUnreadState();}});}function ia(ma,na,oa){ma._maxCount[na]=false;ba(ma,na,{});ma._allReadTimestamp[na]=Math.max(ma._allReadTimestamp[na]||0,oa||0);ma._threadInformer.updatedUnreadState();}function ja(ma,na){return na.map(ma._serverRequests.convertThreadIDIfAvailable.bind(ma._serverRequests));}function ka(ma,na){v.forEach(function(oa){var pa=da(ma,oa);if(!pa)return;for(var qa in na){var ra=na[qa];if(pa[qa]){pa[ra]=pa[qa];delete pa[qa];}}ba(ma,oa,pa);});}function la(ma){return s(v,ma);}o.registerCallback('mercury-unread-state',function(){var ma={};ma.unread={};ma.unread_max_count={};var na=aa._getInstances();for(var oa in na){ma.unread[oa]={};ma.unread_max_count[oa]={};v.forEach(function(pa){ma.unread[oa][pa]=t({},da(na[oa],pa));ma.unread_max_count[oa][pa]=na[oa]._maxCount[pa];});}return ma;});e.exports=aa;});
__d("MercuryThreadMetadataRawRenderer",["Event","CSS","DOM","MercuryActionStatus","MercuryErrorInfo","MessagingTag","MercuryStatusTemplates","Tooltip","URI","WebMessengerPermalinkConstants","cx","tx"],function(a,b,c,d,e,f){var g=b('Event'),h=b('CSS'),i=b('DOM'),j=b('MercuryActionStatus'),k=b('MercuryErrorInfo'),l=b('MessagingTag'),m=b('MercuryStatusTemplates'),n=b('Tooltip'),o=b('URI'),p=b('WebMessengerPermalinkConstants'),q=b('cx'),r=b('tx'),s={renderParticipantListWithNoThreadName:function(u,v,w,x,y,z){var aa={callback:true,check_length:true,show_unread_count:true};z=z||{};var ba={};for(var ca in z)if(aa[ca]){ba[ca]=z[ca];delete z[ca];}var da=w.map(function(ia){return x[ia];}),ea=this.renderRawParticipantList(u,da,w.length,z);ea=this.renderRawTitleWithUnreadCount(ea,ba.show_unread_count?v.unread_count:0);var fa=z.abbr_mode,ga={};for(var ha in z)ga[ha]=z[ha];ga.abbr_mode=true;y.forEach(function(ia){var ja=y.length>1?this._cloneIfDOMElement(ea):ea;i.setContent(ia,ja);if(ba.check_length&&!fa&&ia.scrollWidth>ia.clientWidth){var ka=this.renderRawParticipantList(u,da,w.length,ga),la=this.renderRawTitleWithUnreadCount(ka,ba.show_unread_count?v.unread_count:0);i.setContent(ia,la);}}.bind(this));ba.callback&&ba.callback(ea);},renderRawParticipantList:function(u,v,w,x){var y={abbr_mode:true,last_separator_uses_and:true,names_renderer:true};x=x||{};var z=null;if(x.names_renderer){z=x.names_renderer(v);}else z=v.map(function(ca){return ca.name;});var aa=null;if(z.length===0){if(!u){aa="New Message";}else aa="No Participants";}else if(z.length==1){aa=z[0];}else if(z.length==2){var ba={participant1:z[0],participant2:z[1]};if(x.last_separator_uses_and){aa=r._("{participant1} and {participant2}",ba);}else aa=r._("{participant1}, {participant2}",ba);}else if(x.last_separator_uses_and){if(x.abbr_mode){aa=r._("{participant1} and {others_link}",{participant1:z[0],others_link:this.renderRawParticipantCount(u,{render_subset:true,count:w-1})});}else if(z.length==3){aa=r._("{participant1}, {participant2} and {participant3}",{participant1:z[0],participant2:z[1],participant3:z[2]});}else aa=r._("{participant1}, {participant2} and {others_link}",{participant1:z[0],participant2:z[1],others_link:this.renderRawParticipantCount(u,{render_subset:true,count:w-2})});}else if(z.length==3){aa=r._("{participant1}, {participant2}, {participant3}",{participant1:z[0],participant2:z[1],participant3:z[2]});}else aa=r._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:z[0],participant2:z[1],participant3:z[2],others_link:this.renderRawParticipantCount(u,{render_subset:true,count:w-3})});if(Array.isArray(aa))aa=i.create('span',{},aa);return aa;},renderRawTitleWithUnreadCount:function(u,v){var w=u;if(v&&v>1)w=i.create('span',{},r._("{conversation_title} ({unread_count})",{conversation_title:u,unread_count:v}));return w;},renderRawParticipantCount:function(u,v){var w=v.render_subset,x;if(!w){x=v.count>1?r._("{num} people",{num:v.count}):"1 person";}else x=v.count>1?r._("{others_count} others",{others_count:v.count}):"1 other";return x;},renderShortNames:function(u){if(u.length==1)return [u[0].name];return u.map(function(v){return v.short_name;});},getUserCanonicalTitanURL:function(u,v,w){var x=new o().setSubdomain('www'),y=u.substr(u.indexOf(':')+1);x.setPath(t(w)+'/'+y);v&&v(x.toString());return x.toString();},getTitanURLWithServerID:function(u,v,w){var x=new o().setSubdomain('www');x.setPath(p.getURIPathForThreadID(u,t(w)));v&&v(x.toString());return x.toString();},renderUserCanonicalTitanLink:function(u,v,w,x){var y=this.getUserCanonicalTitanURL(u,null,x);v.setAttribute('href',y);w&&w();},renderTitanLinkWithServerID:function(u,v,w,x){var y=this.getTitanURLWithServerID(u,null,x);v.setAttribute('href',y);w&&w();},renderStatusIndicator:function(u,v,w){var x;if(u==j.RESENDING){x=this.renderResendIndicator();}else if(u!==undefined&&u!=j.UNSENT&&u!=j.UNCONFIRMED&&u!=j.SUCCESS)x=this.renderErrorIndicator(v,w);return x;},renderResendIndicator:function(){return m[':fb:mercury:resend-indicator'].render();},renderErrorIndicator:function(u,v){if(!u)return null;var w=m[':fb:mercury:error-indicator'].render(),x=u.is_transient,y=k.getMessage(u);if(x)if(k.isConnectionError(u)){y=r._("{message} Check your network connection or click to try again.",{message:y});}else y=r._("{message} Click to send again.",{message:y});n.set(w,y,'above','center');if(v&&x){g.listen(w,'click',v);w.setAttribute('tabindex','0');h.addClass(w,"_55q-");}return w;},_cloneIfDOMElement:function(u){if(u.cloneNode){return u.cloneNode();}else return u;}};function t(u){var v=p.BASE_PATH;if(u&&u!=l.INBOX)v+='/'+u;return v;}e.exports=s;});
__d("MercuryThreadSearchUtils",["escapeRegex","TokenizeUtil"],function(a,b,c,d,e,f){var g=b('escapeRegex'),h=b('TokenizeUtil'),i={wordsInString:function(j){return (j||'').split(/\s+/).filter(function(k){return k.trim().length>0;});},anyMatchPredicate:function(j,k){for(var l=0;l<j.length;l++)if(k(j[l]))return true;return false;},allMatchPredicate:function(j,k){for(var l=0;l<j.length;l++)if(!k(j[l]))return false;return true;},queryWordMatchesAnyNameWord:function(j,k){var l=new RegExp('\\b'+g(j),'i');return this.anyMatchPredicate(k,function(m){var n=h.parse(m).flatValue;return l.test(n);});},queryMatchesName:function(j,k){var l=this.wordsInString(j),m=this.wordsInString(k);return this.allMatchPredicate(l,function(n){return this.queryWordMatchesAnyNameWord(n,m);}.bind(this));}};e.exports=i;});
__d("Dcode",[],function(a,b,c,d,e,f){var g,h={},i={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};(function(){var k=[];for(var l in i){h[i[l]]=l;k.push(i[l]);}k.reverse();g=new RegExp(k.join("|"),'g');})();var j={encode:function(k){return encodeURIComponent(k).replace(/([_A-Z])|%../g,function(l,m){return m?'%'+m.charCodeAt(0).toString(16):l;}).toLowerCase().replace(g,function(l){return h[l];});},decode:function(k){return decodeURIComponent(k.replace(/[_A-Z]/g,function(l){return i[l];}));}};e.exports=j;});
__d("runAfterScrollingStops",["Arbiter","Event","Run","debounceAcrossTransitions","emptyFunction"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('Event'),i=b('Run'),j=b('debounceAcrossTransitions'),k=b('emptyFunction');function l(w,x,y){if(x&&o[x])return;if(!n){g.subscribe('page_transition',v);n=true;}if(!m){w();return;}x&&(o[x]=1);p.push(w);if(!y){if(r){i.onLeave(v);r=false;}q.push(p.length-1);}}var m,n,o={},p=[],q=[],r=true,s=500,t=j(function(){m=false;var w=p;p=[];q=[];o={};for(var x=0,y=w.length;x<y;++x)w[x]();},s);function u(){m=true;t();}function v(){var w=q;q=[];r=true;for(var x=0,y=w.length;x<y;++x)p[w[x]]=k;}h.listen(window,'scroll',u);e.exports=l;});
__d("PresenceCookieManager",["Cookie","CurrentUser","Dcode","ErrorUtils","JSLogger","PresenceInitialData","PresenceUtil","URI"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('CurrentUser'),i=b('Dcode'),j=b('ErrorUtils'),k=b('JSLogger'),l=b('PresenceInitialData'),m=b('PresenceUtil'),n=b('URI'),o=l.cookieVersion,p=l.dictEncode,q='presence',r={},s=null,t=null,u=k.create('presence_cookie');function v(){try{var z=g.get(q);if(s!==z){s=z;t=null;if(z&&z.charAt(0)=='E')z=i.decode(z.substring(1));if(z)t=JSON.parse(z);}if(t&&(!t.user||t.user===h.getID()))return t;}catch(y){u.warn('getcookie_error');}return null;}function w(){return parseInt(Date.now()/1000,10);}var x={register:function(y,z){r[y]=z;},store:function(){var y=v();if(y&&y.v&&o<y.v)return;var z={v:o,time:w(),user:h.getID()};for(var aa in r)z[aa]=j.applyWithGuard(r[aa],r,[y&&y[aa]],function(ea){ea.presence_subcookie=aa;});var ba=JSON.stringify(z);if(p)ba='E'+i.encode(ba);if(m.hasUserCookie()){var ca=ba.length;if(ca>1024)u.warn('big_cookie',ca);var da=n.getRequestURI(false).isSecure()&&!!g.get('csm');g.set(q,ba,null,null,da);}},clear:function(){g.clear(q);},getSubCookie:function(y){var z=v();if(!z)return null;return z[y];}};e.exports=x;});
__d("PresenceState",["Arbiter","ErrorUtils","JSLogger","PresenceCookieManager","copyProperties","debounceAcrossTransitions","setIntervalAcrossTransitions","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('PresenceCookieManager'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m=b('setIntervalAcrossTransitions'),n=b('PresenceInitialData'),o=n.cookiePollInterval||2000,p=[],q=[],r=null,s=null,t=0,u=null,v=0,w=['sb2','t2','lm2','uct2','tr','tw','at','wml'],x=i.create('presence_state');function y(){return j.getSubCookie('state');}function z(){t=Date.now();j.store();da(s);}var aa=l(z,0);function ba(ia){if(typeof ia=='undefined'||isNaN(ia)||ia==Number.POSITIVE_INFINITY||ia==Number.NEGATIVE_INFINITY)ia=0;return ia;}function ca(ia){var ja={};if(ia){w.forEach(function(ma){ja[ma]=ia[ma];});if(t<ia.ut)x.error('new_cookie',{cookie_time:ia.ut,local_time:t});}ja.ut=t;for(var ka=0,la=p.length;ka<la;ka++)h.applyWithGuard(p[ka],null,[ja]);s=ja;return s;}function da(ia){v++;t=ba(ia.ut);if(!r)r=m(ga,o);s=ia;if(u===null)u=ia;for(var ja=0,ka=q.length;ja<ka;ja++)h.applyWithGuard(q[ja],null,[ia]);v--;}function ea(ia){if(ia&&ia.ut)if(t<ia.ut){return true;}else if(ia.ut<t)x.error('old_cookie',{cookie_time:ia.ut,local_time:t});return false;}function fa(){var ia=y();if(ea(ia))s=ia;return s;}function ga(){var ia=y();if(ea(ia))da(ia);}j.register('state',ca);g.subscribe(i.DUMP_EVENT,function(ia,ja){ja.presence_state={initial:k({},u),state:k({},s),update_time:t,sync_paused:v,poll_time:o};});(function(){var ia=fa();if(ia){da(ia);}else{x.debug('no_cookie_initial');da(ca());return;}})();var ha={doSync:function(ia){if(v)return;if(ia){z();}else aa();},registerStateStorer:function(ia){p.push(ia);},registerStateLoader:function(ia){q.push(ia);},get:function(){return fa();},getInitial:function(){return u;},verifyNumber:ba};e.exports=ha;});
__d("TypingDetector",["ArbiterMixin","Event","Input","Run","copyProperties","createObjectFrom","emptyFunction"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('Event'),i=b('Input'),j=b('Run'),k=b('copyProperties'),l=b('createObjectFrom'),m=b('emptyFunction');function n(o){this._input=o;this._ignoreKeys={};}n.INACTIVE=0;n.TYPING=1;n.QUITTING=2;k(n.prototype,g,{_timeout:7000,_currentState:n.INACTIVE,init:function(){this.init=m;this.reset();h.listen(this._input,'keyup',this._update.bind(this));j.onUnload(this._onunload.bind(this));},reset:function(){clearTimeout(this._checkTimer);this._checkTimer=null;this._lastKeystrokeAt=null;this._currentState=n.INACTIVE;},setIgnoreKeys:function(o){this._ignoreKeys=l(o);},_onunload:function(){if(this._currentState==n.TYPING)this._transition(n.QUITTING);},_update:function(event){var o=h.getKeyCode(event),p=this._currentState;if(!this._ignoreKeys[o])if(i.getValue(this._input).trim().length===0){if(p==n.TYPING)this._transition(n.INACTIVE);}else if(p==n.TYPING){this._recordKeystroke();}else if(p==n.INACTIVE){this._transition(n.TYPING);this._recordKeystroke();}},_transition:function(o){this.reset();this._currentState=o;this.inform('change',o);},_recordKeystroke:function(){this._lastKeystrokeTime=Date.now();if(!this._checkTimer)this._checkTimer=setTimeout(this._checkTyping.bind(this),this._timeout);},_checkTyping:function(){var o=this._lastKeystrokeTime+this._timeout,p=Date.now();if(p>o){this._transition(n.INACTIVE);}else{clearTimeout(this._checkTimer);this._checkTimer=setTimeout(this._checkTyping.bind(this),o-p+10);}}});e.exports=n;});